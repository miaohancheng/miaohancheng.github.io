<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Miao Hancheng&#39;s Blog</title>
  
  
  <link href="https://miaohancheng.github.io/atom.xml" rel="self"/>
  
  <link href="https://miaohancheng.github.io/"/>
  <updated>2025-03-10T08:02:51.530Z</updated>
  <id>https://miaohancheng.github.io/</id>
  
  <author>
    <name>Miao Hancheng</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>巴菲特芒格投资笔记</title>
    <link href="https://miaohancheng.github.io/2025/03/10/%E5%B7%B4%E8%8F%B2%E7%89%B9%E8%8A%92%E6%A0%BC%E6%8A%95%E8%B5%84%E7%AC%94%E8%AE%B0/"/>
    <id>https://miaohancheng.github.io/2025/03/10/%E5%B7%B4%E8%8F%B2%E7%89%B9%E8%8A%92%E6%A0%BC%E6%8A%95%E8%B5%84%E7%AC%94%E8%AE%B0/</id>
    <published>2025-03-10T15:00:00.000Z</published>
    <updated>2025-03-10T08:02:51.530Z</updated>
    
    <content type="html"><![CDATA[<p><strong>核心投资哲学</strong></p><p>​•<strong>价值投资原则</strong>：巴菲特和芒格坚持以企业的内在价值为基础进行投资，强调“价格是你所付出的，价值是你所得到的”。他们把股票看作所投资企业的一部分，而非仅仅是交易代码，注重企业长期的盈利能力和增长潜力，而非市场情绪的短期波动  。巴菲特引用导师本杰明·格雷厄姆的比喻描述理想的投资心态：把市场先生视为服务于你的伙伴而非指导你的老师——当市场情绪极度乐观或悲观时，明智的投资者要么 <strong>忽略</strong> 市场先生的报价，要么 <strong>利用</strong> 它带来的机会 。正因如此，他们强调在买入时留有足够的“安全边际”，以便即使估值判断稍有错误也不会招致永久性损失（芒格亦告诫“不应轻易打断复利的进程”，即避免因为短期波动而卖出优质资产）。总的来说，他们奉行 <strong>“第一条规则是不亏损，第二条是记住第一条”</strong> 的原则，以确保长期资本稳健增值。</p><p>​•<strong>长期主义与复利效应</strong>：巴菲特和芒格深知长期持有优秀企业所带来的复利威力。他们常引用爱因斯坦的话将复利比作“世界第八大奇迹”，并以自身实践证明其威力：伯克希尔从几十年前的小型合伙企业成长为市值逾千亿美元的投资巨头，即是长期复利积累的结果。他们主张以<strong>多年甚至数十年</strong>为尺度来看待投资，“时间是优秀企业的朋友，却是平庸企业的敌人” 。也就是说，如果买入的是一家“了不起的公司”，时间拉长后价值终将体现；反之，平庸公司纵使暂时便宜，长期持有往往问题不断。这体现了长期主义的精髓：通过 <strong>耐心持有</strong> 优质资产，让复利为你工作。芒格甚至形象地指出：“不要因为一时心急而拔苗助长，也不要在复利增长过程中轻易中断。”正是这种耐心和纪律，使他们能够跨越牛熊周期获取超额收益。</p><p>​•<strong>投资与投机的区别</strong>：在巴菲特和芒格看来，投资与投机有本质区别。<strong>投资</strong> 是基于企业基本面价值的判断，期待从企业长期经营成果中获利；<strong>投机</strong> 则是赌市场情绪和价格波动，意在从下一笔交易中套利。巴菲特形象地说，投资者关注的是企业将来的经营状况，投机者关注的是股票近期的价格走势。他们强调投资应有 <strong>主人翁心态</strong> ——购买股票就意味着购入了一家企业，应当像经营企业那样思考。而投机者往往<strong>情绪化追涨杀跌</strong>，容易受到“贪婪与恐惧”这两种传染病的支配。对此巴菲特的忠告是：“在别人贪婪时恐惧，在别人恐惧时贪婪” 。也就是说，当市场疯狂炒作时要保持冷静谨慎；当市场恐慌抛售优质资产时反而要敢于贪婪地逢低吸纳。这种逆向思维正是基于对投资与投机区别的清醒认识：真正的投资是在市场情绪最悲观时播下种子，在漫长岁月中等待价值开花结果。</p><p><strong>选股标准</strong></p><p>​•<strong>长期竞争优势（护城河）</strong>：巴菲特提出伟大公司的首要特征是拥有 <strong>持久的经济护城河</strong>。也就是企业具有难以被竞争对手复制或超越的竞争优势，能够长期获得超额回报 。这种护城河可以来源于强大的品牌（例如可口可乐在全球拥有独一无二的品牌认知度）、网络效应、专利技术、成本领先（如GEICO通过低成本运营获得优势）等。不论形式如何，护城河能保护企业的“城堡”不被竞争对手攻破，使其在岁月流逝中依然保持高额的投资回报率 。反之，没有护城河的企业其高盈利很快会吸引竞争，利润将被侵蚀。正如巴菲特所警示的：“资本主义的运作保证了竞争者会反复冲击任何高利润的‘城堡’。因此，一个<strong>强大且持久的护城河</strong>（例如极低的成本或全球知名品牌）对持续成功至关重要。商业史上有太多‘罗马烛火’式的公司，它们的护城河被证明只是幻觉，转瞬即逝” 。因此，巴菲特和芒格在选股时格外关注企业是否具备 <strong>可延续几十年的独特优势</strong>，这也是他们钟爱可口可乐、喜诗糖果（See’s Candies）等公司的原因所在。</p><p>​•<strong>优秀的管理层和企业文化</strong>：管理层的诚信与能力是巴菲特和芒格选股时的另一大考量。他们强调只与值得信赖、聪明能干的管理者“同舟共济”。巴菲特坦言：“我们寻找由能干而诚实的管理者经营的公司” 。在他们看来，卓越的管理层能合理分配资本、稳健经营，并以股东利益为重。芒格也一再强调<strong>诚信</strong>的重要性，认为没有诚信的聪明反而会害了公司。他们喜欢投资那些管理层以身作则、注重长期价值而非短期收益的企业，并且企业文化健康向上。例如，巴菲特称赞苹果公司的CEO蒂姆·库克是“最出色的管理者之一”，对业务了如指掌且管理公司井井有条 ；这样的“诚实贤能的掌舵人”让他们对企业充满信心。相反，即使企业本身有潜力，如果管理层水平低下或道德有亏，他们也避而远之。可以说，<strong>选人</strong> 与 <strong>选企业</strong> 同样重要，正如巴菲特所言：“好骑师难救劣马”，管理再优秀，若产业本质不好也无回天之力 ；但反过来讲，再好的赛马（好生意）也需要可靠的骑师（好管理）来发挥潜能。</p><p>​•<strong>财务稳健性</strong>：巴菲特和芒格偏好财务结构稳健、盈利能力强的公司。具体来说，他们寻找那些<strong>利润率高、股本回报率(ROE)出色且负债水平低</strong>的企业。这类公司通常意味着经营效率高、内生现金流充沛，不需要过度依赖外部债务融资。巴菲特在2019年致股东信中总结理想投资标的的标准首先就是：“它能够在其运营所需的有形资本上获得良好的回报” 。持续高ROE通常是公司拥有护城河的体现。同时，他也警惕高杠杆风险，倾向于企业保持稳健的资产负债表。在选股时，他们会仔细研读财务报表，关注营业利润率、自由现金流等指标，以确认公司<strong>盈利模式健康可持续</strong>。例如，伯克希尔长期持有的喜诗糖果每年都能产生可观的现金盈余且几乎无债务，这正是财务稳健带来持续价值创造的实例。相反，财务数据动荡、债台高筑的公司往往被他们排除在投资名单之外。</p><p>此外，巴菲特和芒格通常只投资他们<strong>懂的业务</strong>。所谓“能力圈”概念，即在自己理解的行业领域内选股。他们回避那些看不懂或快速变化的行业，因为无法判断其中公司的长期经济特性。这个原则贯穿于选股标准的方方面面：只有在理解业务模型的前提下，才能评估护城河是否稳固、管理层决策是否明智、财务数字是否可信。因此，他们的投资组合中多是消费品、金融、工业等相对熟悉的领域，而对生物科技、新兴互联网等超出能力圈的机会则宁可错过也不贸然涉足。这种自律使他们避免了很多看似热门实则风险难测的投资，保证了投资标准的一贯性和可靠性。</p><p><strong>买入决策</strong></p><p>​•<strong>估值方法（合理价格买入）</strong>：巴菲特常说：“以合理的价格买入一家出色的公司，远胜于以出色的价格买入一家平庸的公司” 。这反映了他在估值上的核心理念：<strong>宁可为高品质企业支付略高于账面估值的合理价，也不要因为便宜而买入一家前景黯淡的平庸公司</strong>。具体而言，他们会先计算出企业的内在价值（基于未来现金流折现或资产价值等），然后只在股价显著低于内在价值时才买入，从而留出“安全边际”。巴菲特将这种低估买入的机会比喻为捡便宜的雪茄烟蒂（只剩一口却非常便宜）和购买璀璨的希望钻石（一部分胜过一堆廉价仿制品）之间的权衡 。早年他曾热衷于“廉价捡漏”式投资，但后来在芒格影响下转向“以公道价格买入优质企业”的策略，这一点从他收购喜诗糖果的经历中得到印证。估值时他们也关注<strong>绝对收益率</strong>：预期买入后能获得的股东收益率（包括盈利增长和股息）必须显著高于无风险利率和市场平均水平，才值得出手。总之，他们的买入决策建立在严谨的估值分析基础上，既不会盲目追高（坚决回避“高估值炒作”），也不会因为价格便宜就忽视质量。只有当<strong>“价格&lt;价值”</strong>且有足够余地时，他们才会果断买入。</p><p>​•<strong>何时买入（逆向思维）</strong>：在择时方面，巴菲特和芒格秉持逆向投资的思维——<strong>在他人恐惧时贪婪</strong>。当市场出现非理性恐慌、优质公司股价大跌时，他们往往视之为千载难逢的买入良机。例如1973-74年熊市中巴菲特大举买入华盛顿邮报，公司基本面并未受损但股价跌去大半，结果获取巨额回报。对此巴菲特在致股东信中直言，他们从不试图预测市场何时见顶或见底，也无法预知贪婪或恐惧何时蔓延，但可以确定的是市场周期性的情绪<strong>终将带来价格大幅偏离价值的机会</strong>。他说：“我们只是力求在别人贪婪时保持恐惧，而在别人恐惧时变得贪婪” 。因此，当优质股票因短期利空被恐慌抛售、股价远低于内在价值时，他们会大胆地逢低买入。而当市场狂热、股票被疯狂追捧导致估值远超内在价值时，他们会格外谨慎，不会跟风投入。巴菲特形容自己“别人的宏观预测听归听，但从不据此调整投资”，更多是<strong>静待机会</strong>而非主动择时。实际上，许多伯克希尔的重大投资都是在市场低迷时期完成的：例如1987年股灾后的可口可乐、2008年金融危机中的高盛优先股等。可见，他们的买入时机往往逆大众情绪而动，在市场最悲观时坚定地为未来布局。</p><p>​•<strong>分批与集中</strong>：在具体执行上，巴菲特倾向于在估值合理或低估时<strong>集中买入</strong>足够多的仓位，而非每天小额频繁交易。他曾打趣“好机会并不常有，一旦碰上就要<strong>用力挥棒</strong>（全力出击）”。这意味着如果判断某只股票非常有吸引力，他会果断地买入大量股票建立重仓，而不像一般投资者那样畏首畏尾、小打小闹。同时，他们也会分批建仓以优化成本：比如分几次在下跌过程中逐步买入，从而摊低整体成本价。在买入决策上，芒格比喻为“捡起地板上的准一美元硬币，用五毛钱的价格买下”，这样的好买卖出现时要集中火力。而当手头没有满意的投资标的时，他们宁可让现金闲置，也不会为了“资金利用率”去随便买入次优资产。正因为这种耐心等待和集中出击的策略，伯克希尔的投资往往<strong>命中率极高</strong>，很少出现频繁调仓的情况。</p><p><strong>持有策略</strong></p><p>​•<strong>长期持有</strong>：巴菲特名言：“我们最喜欢的持有期是永远” 。对于符合他们标准的优秀公司，一旦买入，他们往往持股多年乃至数十年之久，把时间当作朋友，充分享受企业成长带来的复利效应。他们与那些稍有涨幅就急于获利了结、或遇到风浪就惊慌抛售的投资者截然不同，而是更像耐心的园丁，种下好树后静待其成长茁壮。例如，可口可乐公司自1988年买入后，伯克希尔已持有超过30年，从未因为短期波动而卖出，其市值和分红回报已令初始投资增长了几十倍。同样，喜诗糖果自1972年收购后，每年贡献的现金流源源不断地为伯克希尔创造价值。芒格曾幽默地说，<strong>“坐着不动”</strong> 是投资中最容易被低估的本领：找到值得长期持有的好股票后，最明智的做法往往是什么也不做，让复利自行滚雪球。因此，除非有非常特殊的情况（见下条），他们一般不会轻易卖出优质持仓。</p><p>​•<strong>何时卖出</strong>：尽管倾向永久持有，巴菲特和芒格也承认有少数情形会考虑卖出股票。首先是 <strong>基本面恶化</strong>：如果一家公司的经济护城河缩小甚至消失，或者管理层发生不可接受的改变，使得当初买入的投资逻辑不再成立，他们会果断地退出投资。巴菲特表示，他们买股票并没有预设卖出的时间或价格，<strong>只要企业的内在价值能以令人满意的速度增长，就会一直持有</strong> ；反之，如果发现企业前景不妙，增长停滞甚至倒退，则不恋战，及时止损。其次是 <strong>更好的机会出现</strong>：如果手头某持仓相对于其内在价值已充分反映（甚至高估），而市场上出现了一个更具吸引力的新投资机会，他们可能会调仓。巴菲特将这种再平衡看作资本再配置的正常操作，但他也提醒<strong>不要过度频繁换马</strong>，因为优秀机会毕竟少数，大部分情况下“手中鸟”胜过“林中两鸟”。再次，有时出于 <strong>投资组合考虑或政策因素</strong> 也会部分减持，例如伯克希尔曾在持股比例过高或监管限制时略微减持某些股票（如苹果在2020年被动减持一些以避免持股比例过大）。总的来说，他们卖出的频率远低于买入，一旦选定公司，默认策略是伴随公司成长一路同行，除非上述条件迫使他们分手。</p><p>​•<strong>应对市场波动</strong>：巴菲特和芒格对市场波动的看法是 <strong>“不预测、不恐惧、善加利用”</strong>。他们不会因为股价每日波动而改变对企业价值的判断，也不尝试抓住每一次涨跌赚快钱。相反，他们把市场视为情绪多变的伙伴“市场先生”(Mr. Market) 。市场先生每日报出价格，但有时过于乐观、有时过度悲观，报价常常偏离实际价值。然而，<strong>市场先生乐于被忽略</strong>：如果当天价格不合意，可以什么也不做；如果价格荒谬地低，则是捡便宜的好机会 。这种心态使他们在股市大幅下挫时依然镇定，从基本面出发评估是否逢低加仓，而不是被恐慌情绪裹挟随大流卖出。同样，在股价非理性高涨时，他们也不会兴奋追高，而是警觉地审视风险。巴菲特打过比方，说即便证券市场关闭几年，对他们影响也不大，因为<strong>企业的长期业绩终将决定投资成败</strong>，短期行情只是提供报价的噪音 。因此，他们应对波动的策略是：<strong>平常心看待</strong>，不被情绪牵着走；同时当波动导致价格大跌远低于价值时，<strong>果断出手</strong> 逆势买入优质资产。在这一进一退中，将市场波动由敌人变成了朋友。</p><p>​•<strong>加仓与减仓策略</strong>：在持有期间，巴菲特和芒格也会根据情况调整仓位配置。对于前景依然看好且出现价格下跌的持仓，他们往往选择 <strong>加仓</strong>。只要确定公司基本面未变，股价下跌反而提供了更便宜的买入机会，巴菲特称这是“给喜爱的公司打折”——例如他多次在市场低迷时增持富国银行和美国运通等股票。当2008年金融危机重挫股市时，伯克希尔不仅没有抛售核心持股，反而在债券和优先股等领域大举投资，为日后收益打下基础。相反，对于那些情况变差的投资，他们会 <strong>止损减仓</strong> 或清仓，不恋战、不摊大亏。芒格形容这一进一出就像做减法：<strong>“除去糟糕的，留住优秀的”</strong>。值得注意的是，他们极少因为短期股价涨高就减仓锁定利润，如果公司依旧优秀，他们更倾向于一路拿牢，让利润奔跑。只有当某持仓的估值明显过高、未来回报预期很低时，才可能逐步减仓转向别处。同样地，如果持仓比例过大增加了风险（比如某一行业或单一股票权重过高），他们也可能适度调整以保持组合平衡。但总体而言，加减仓的频率都不高——正如巴菲特所言，他们更喜欢 <strong>“懒惰”</strong> 一点，耐心守着那些经过深思熟虑选出的赢家，而不是频繁买进卖出。</p><p><strong>案例分析</strong></p><p>在漫长的投资生涯中，巴菲特和芒格通过伯克希尔·哈撒韦进行了一系列经典投资，这些案例生动展现了上述投资理念的实践成果。以下选取成功和失败的代表性案例加以分析：</p><p>​•<strong>成功案例：可口可乐（Coca-Cola）</strong> – 巴菲特于1988年在市场低迷之际大举买入可口可乐，当时耗资逾10亿美元获得公司约7%的股份 。他之所以钟情可口可乐，正是看中了其强大的品牌护城河和全球化潜力。当时可口可乐拥有全世界最具辨识度的品牌之一，产品“无可替代”，消费者忠诚度极高。这符合他对伟大企业的定义：消费者“需要或想要”它的产品，且“认为没有接近的替代品” 。可口可乐的商业模式简单清晰（浓缩液销售），毛利率极高，且在新兴市场有广阔增长空间。更重要的是，公司拥有稳健的管理层，当时CEO戈伊苏埃塔(Roberto Goizueta)大刀阔斧拓展全球业务，提升股东回报。巴菲特预见到，可口可乐这种拥有<strong>宽护城河</strong>的优秀企业，哪怕付出略高的市盈率也是值得的，因为时间会使其价值得到充分体现。他在买入后公开表示“我们预计将长期持有这些股票” 。事实证明，这笔投资极为成功：此后几十年可口可乐持续增长，伯克希尔从中获得了巨额的股息和资本增值。目前其持股市值已超过最初成本的20倍。可口可乐案例体现了价值投资的精髓——在 <strong>“别人恐惧”</strong> 时以合理价买入“护城河深厚”的伟业，并通过 <strong>长期持有</strong> 分享企业成长红利。</p><p>​•<strong>成功案例：苹果公司（Apple）</strong> – 虽然巴菲特曾长期回避科技股，但2016年他开始建仓苹果公司，几年来投入逾300亿美元购入约5%的苹果股份。苹果之所以能打动这对投资搭档，正是因为它兼具<strong>强大的护城河和卓越的管理</strong>。一方面，苹果建立了独特的生态系统和品牌忠诚度。iPhone等产品在消费者心智中拥有不可取代的地位，用户粘性极高——巴菲特举例说：“如果你是苹果用户，有人给你一万美元但要求你此生不再买iPhone，你根本不会接受” 。相较之下，若有人出钱让你此生不买某品牌汽车，你可能拿钱转买竞争品牌。这个极端对比说明了苹果产品对消费者的价值是高度独占的，这正是苹果巨大的 <strong>无形护城河</strong>（品牌和生态）所在。另一方面，巴菲特对苹果管理层的执行力赞誉有加，称CEO蒂姆·库克“非常杰出，明白如何经营业务，把公司管理得无与伦比地好” 。库克接班后持续打造供应链优势，扩大服务业务，使苹果盈利和现金流再上台阶。在财务上，苹果拥有庞大的现金储备和惊人的盈利能力（ROE常年超过<strong>40%<strong>），几乎是巴菲特所见过“全世界最优秀的生意”之一。伯克希尔买入苹果后股价一路攀升，目前这项投资市值已超过1000亿美元，收益率惊人，同时苹果每年还向伯克希尔支付数十亿股息。苹果案例显示，即使是在科技行业，</strong>只要公司拥有可持续竞争优势和一流管理</strong>，价值投资的方法同样奏效。巴菲特把苹果视为伯克希尔的“第三大业务”，而非一只普通股票，可见其长线持有的决心。</p><p>​•<strong>失败案例：伯克希尔纺织业务</strong> – 伯克希尔·哈撒韦公司本身最初是一家纺织厂，这是巴菲特早年在1960年代以“烟蒂股”思维收购的低价产业。当时纺织业已走向衰落，但他侥幸地认为凭借便宜的收购价和自己的管理改进或可扭转颓势。然而事实证明，纺织业务的<strong>行业经济属性太差</strong>，无论投入多少资金技改，都无法获得像样的回报。这成为巴菲特投资生涯中一个深刻的教训：他后来感叹“再好的骑手也无法让一匹跛脚的马赢得比赛”。正如他所总结的：“伯克希尔的纺织业务由诚实能干的人经营，但即便是这样的优秀管理层，在经济特性糟糕的行业中也寸步难行，如同在‘流沙’中奔跑，永远无法取得进展” 。最终，巴菲特在1985年不得不关闭了纺织厂业务，承认了这笔投资的失败。他事后反思道，如果当初把买纺织厂的钱直接投向股票市场或其他好企业，股东财富本可以增长得更多。纺织业案例教训在于：<strong>没有护城河的夕阳行业，再便宜也不值得长期投资</strong>。巴菲特从中学到要“远离坏生意”，日后他宁可以公允价买入伟大公司，也不愿贪便宜染指经济前景不佳的行业。</p><p>​•<strong>失败案例：航空公司投资</strong> – 巴菲特对航空业的态度可谓一波三折，但总体而言这是令他 <strong>“折戟”</strong> 较多的领域。早在2007年致股东信中，他就将航空公司列为“糟糕行业”的典型代表之一，戏言道：“如果有远见的资本家在1903年莱特兄弟起飞时就在场，他本该一枪把他们打下来，这会让后来者省下无数财富” 。这番诙谐却辛辣的话揭示了航空业长期存在的问题：<strong>资本投入大、竞争激烈、盈利薄弱</strong>。几十年来，航空公司集体亏损累累，投资者投入的资金仿佛填不满无底洞。然而，巴菲特也曾两度涉足这一他所不看好的行业。一次是1989年他购买了USAir的优先股，当时因高息票面看似诱人，但不久公司业绩就急转直下，连利息都无法支付。巴菲特称这次投资是出于“一时愚蠢”，公司很快陷入财务困境，好在后来行业景气回升时他抓住机会在1998年卖出了持股，竟意外取得不错的回报。但事后证明这只是<strong>侥幸逃脱</strong>——USAir在他卖出后的十年间两度破产 。第二次是2016年左右，伯克希尔出人意料地买入了美国四大航空公司的股票（达美、西南、美国、联合），一度成为这些公司的主要股东。起初几年航空业盈利改善，巴菲特的持仓市值也上涨。然而2020年新冠疫情突袭使航空业遭受重创，需求断崖式下跌。巴菲特在2020年承认对行业前景判断失误，迅速以低价清仓了所有航空股，蒙受了数十亿美元的损失。这次教训再次印证了他先前的观点：航空业缺乏可靠的护城河，外部冲击下极易变为<strong>惨烈的亏损陷阱</strong>。总结航空业的失败案例，我们可以看到，即便是经验老到如巴菲特，有时也会违背自己“避免麻烦行业”的准则而付出代价。不过，他从不讳言错误，并将其转化为日后决策的宝贵经验：正如他说的，“投资最重要的就是不断学习”，哪怕向市场 <strong>昂贵地缴学费</strong> 也要汲取教训，避免重蹈覆辙。</p><p>综上，沃伦·巴菲特和查理·芒格的投资思想体系严谨而完整：从坚持价值为本的 <strong>核心哲学</strong>，到苛刻挑选 <strong>优秀而有护城河的公司</strong>，以合理价格逆势 <strong>买入</strong>，然后耐心长期 <strong>持有</strong> 并回避市场噪音，最后通过正反两方面的 <strong>案例</strong> 总结验证其策略。这套投资逻辑框架强调理性、耐心和纪律，看似简单朴素，却在几十年的实践中助力他们穿越牛熊、创造了惊人的复利神话。对于广大投资者而言，巴菲特和芒格的智慧箴言提供了可靠的指南：<strong>以企业主视角看待投资，专注价值而非价格波动；在具备优势的领域耐心等待机会，以安全边际买入优秀公司；买入后如无重大变故则坚定持有，让时间和复利为你发挥魔力。</strong>这些理念跨越时代而历久弥新，正如巴菲特本人就是最好的例证——他始终坚守这些原则，并乐于将之言传身教，供后来者参考借鉴。  </p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;strong&gt;核心投资哲学&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;​	•	&lt;strong&gt;价值投资原则&lt;/strong&gt;：巴菲特和芒格坚持以企业的内在价值为基础进行投资，强调“价格是你所付出的，价值是你所得到的”。他们把股票看作所投资企业的一部分，而非仅仅是交易代码，注重企业长</summary>
      
    
    
    
    <category term="投资" scheme="https://miaohancheng.github.io/categories/%E6%8A%95%E8%B5%84/"/>
    
    
    <category term="note" scheme="https://miaohancheng.github.io/tags/note/"/>
    
  </entry>
  
  <entry>
    <title>机器学习+深度学习量化</title>
    <link href="https://miaohancheng.github.io/2025/03/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0+%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E9%87%8F%E5%8C%96/"/>
    <id>https://miaohancheng.github.io/2025/03/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0+%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E9%87%8F%E5%8C%96/</id>
    <published>2025-03-08T15:00:00.000Z</published>
    <updated>2025-03-10T08:02:51.530Z</updated>
    
    <content type="html"><![CDATA[<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>最近在港股美股上的收益还可以，但是在择时能力上感觉靠人的判断没有特别的准确，希望通过量化的方式去帮助择时，也不希望做高频，只希望高抛低吸做t的时候可以更准确</p><h3 id="调研"><a href="#调研" class="headerlink" title="调研"></a>调研</h3><p>一开始尝试了bigquant，发现需要开会员才能用到比较高级的因子和策略，所以找了下开源的量化回测框架和数据<br>目前采用的是以下几个库：</p><ol><li><a href="https://github.com/TA-Lib/ta-lib-python:">talib</a></li><li><a href="https://github.com/mementum/backtrader">backtrader</a></li><li><a href="https://github.com/akfamily/akshare">akshare</a></li><li><a href="https://github.com/edtechre/pybroker">pybroker</a></li></ol><p>目前做到的是用机器学习和深度学习来做未来涨跌的判定，dnn&#x2F;gnn的情况还在研究，因为构造数据集和回测框架的兼容上比机器学习难度大一些；</p><h3 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h3><p>特征粗略制作，样本就挑选了一个a股为例</p><h4 id="交易图表："><a href="#交易图表：" class="headerlink" title="交易图表："></a>交易图表：</h4><p><img src="https://github.com/miaohancheng/picx-images-hosting/raw/master/pics/backtrader_plot.7axbcmuk0o.webp" alt="汇总结论"></p><h4 id="执行过程"><a href="#执行过程" class="headerlink" title="执行过程"></a>执行过程</h4><ol><li>模型训练+分步减仓<br><img src="https://github.com/miaohancheng/picx-images-hosting/raw/master/pics/%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B.7snd18d7o4.webp" alt="减仓"></li><li>模型训练+止损<br><img src="https://github.com/miaohancheng/picx-images-hosting/raw/master/pics/%E6%AD%A2%E6%8D%9F.26lmndbwuu.webp" alt="止损"></li></ol><h4 id="数据表现："><a href="#数据表现：" class="headerlink" title="数据表现："></a>数据表现：</h4><ul><li>最终资金: 1,483,439.88 CNY （初始资金：1,000,000.00 CNY）</li><li>回测时间：2018-01-01 至 2025-03-01 的 大A</li><li>年化夏普比率: 0.51</li><li>最大回撤: 30.80% (持续 489 天)</li><li>年化收益率: 5.90%（只能跑赢通胀）</li></ul><h3 id="代码思路："><a href="#代码思路：" class="headerlink" title="代码思路："></a>代码思路：</h3><p>初始化引入：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os<span class="token keyword">import</span> warnings<span class="token keyword">import</span> logging<span class="token keyword">import</span> akshare <span class="token keyword">as</span> ak<span class="token keyword">import</span> backtrader <span class="token keyword">as</span> bt<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd<span class="token keyword">import</span> talib <span class="token keyword">as</span> ta<span class="token keyword">from</span> collections <span class="token keyword">import</span> Counter<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> train_test_split<span class="token keyword">from</span> imblearn<span class="token punctuation">.</span>over_sampling <span class="token keyword">import</span> SMOTE<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword">import</span> StandardScaler<span class="token keyword">import</span> torch<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn<span class="token keyword">import</span> torch<span class="token punctuation">.</span>optim <span class="token keyword">as</span> optim<span class="token comment"># ----------------------- 日志设置与警告屏蔽 -----------------------</span>DEBUG <span class="token operator">=</span> <span class="token boolean">False</span><span class="token keyword">if</span> DEBUG<span class="token punctuation">:</span>    logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'%(asctime)s %(levelname)s: %(message)s'</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'%(asctime)s %(levelname)s: %(message)s'</span><span class="token punctuation">)</span>logger <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>warnings<span class="token punctuation">.</span>filterwarnings<span class="token punctuation">(</span><span class="token string">"ignore"</span><span class="token punctuation">,</span> category<span class="token operator">=</span>UserWarning<span class="token punctuation">)</span>warnings<span class="token punctuation">.</span>filterwarnings<span class="token punctuation">(</span><span class="token string">"ignore"</span><span class="token punctuation">,</span> category<span class="token operator">=</span>FutureWarning<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="模型构建"><a href="#模型构建" class="headerlink" title="模型构建:"></a>模型构建:</h4><ol><li><p>transfromer</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">## ----------------------- Transformer模型定义 -----------------------</span><span class="token keyword">class</span> <span class="token class-name">TransformerClassifier</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_dim<span class="token punctuation">,</span> nhead<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> num_encoder_layers<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> dim_feedforward<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> dropout<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>TransformerClassifier<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment"># 如果 input_dim 不能被 nhead 整除，则增加一个线性层映射到新维度</span>        <span class="token keyword">if</span> input_dim <span class="token operator">%</span> nhead <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>            new_input_dim <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>input_dim <span class="token operator">//</span> nhead<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> nhead            self<span class="token punctuation">.</span>input_proj <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>input_dim<span class="token punctuation">,</span> new_input_dim<span class="token punctuation">)</span>            d_model <span class="token operator">=</span> new_input_dim        <span class="token keyword">else</span><span class="token punctuation">:</span>            self<span class="token punctuation">.</span>input_proj <span class="token operator">=</span> <span class="token boolean">None</span>            d_model <span class="token operator">=</span> input_dim        encoder_layer <span class="token operator">=</span> nn<span class="token punctuation">.</span>TransformerEncoderLayer<span class="token punctuation">(</span>d_model<span class="token operator">=</span>d_model<span class="token punctuation">,</span> nhead<span class="token operator">=</span>nhead<span class="token punctuation">,</span>                                                   dim_feedforward<span class="token operator">=</span>dim_feedforward<span class="token punctuation">,</span> dropout<span class="token operator">=</span>dropout<span class="token punctuation">,</span> batch_first<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>transformer_encoder <span class="token operator">=</span> nn<span class="token punctuation">.</span>TransformerEncoder<span class="token punctuation">(</span>encoder_layer<span class="token punctuation">,</span> num_layers<span class="token operator">=</span>num_encoder_layers<span class="token punctuation">)</span>        <span class="token comment"># 分类层</span>        self<span class="token punctuation">.</span>fc <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>d_model<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># x: (batch_size, seq_length, input_dim)</span>        <span class="token keyword">if</span> self<span class="token punctuation">.</span>input_proj <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>            x <span class="token operator">=</span> self<span class="token punctuation">.</span>input_proj<span class="token punctuation">(</span>x<span class="token punctuation">)</span>        transformer_out <span class="token operator">=</span> self<span class="token punctuation">.</span>transformer_encoder<span class="token punctuation">(</span>x<span class="token punctuation">)</span>  <span class="token comment"># (batch_size, seq_length, d_model)</span>        pooled <span class="token operator">=</span> transformer_out<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>             <span class="token comment"># (batch_size, d_model)</span>        output <span class="token operator">=</span> self<span class="token punctuation">.</span>fc<span class="token punctuation">(</span>pooled<span class="token punctuation">)</span>        <span class="token keyword">return</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>output<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>Bilstm+Attention</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># ------------------ 定义 BiLSTM+Attention 模型 ------------------</span><span class="token keyword">class</span> <span class="token class-name">BiLSTMAttention</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">,</span> num_layers<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>BiLSTMAttention<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>hidden_dim <span class="token operator">=</span> hidden_dim        self<span class="token punctuation">.</span>num_layers <span class="token operator">=</span> num_layers        self<span class="token punctuation">.</span>lstm <span class="token operator">=</span> nn<span class="token punctuation">.</span>LSTM<span class="token punctuation">(</span>input_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">,</span> num_layers<span class="token operator">=</span>num_layers<span class="token punctuation">,</span> batch_first<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> bidirectional<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>        <span class="token comment"># 注意力层：将每个时刻的输出映射为一个得分</span>        self<span class="token punctuation">.</span>attn_layer <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>hidden_dim <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>fc <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>hidden_dim <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># x: (batch_size, seq_length, input_dim)</span>        lstm_out<span class="token punctuation">,</span> _ <span class="token operator">=</span> self<span class="token punctuation">.</span>lstm<span class="token punctuation">(</span>x<span class="token punctuation">)</span>  <span class="token comment"># (batch_size, seq_length, hidden_dim*2)</span>        attn_scores <span class="token operator">=</span> self<span class="token punctuation">.</span>attn_layer<span class="token punctuation">(</span>lstm_out<span class="token punctuation">)</span>  <span class="token comment"># (batch_size, seq_length, 1)</span>        attn_weights <span class="token operator">=</span> torch<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>attn_scores<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># (batch_size, seq_length, 1)</span>        context <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>attn_weights <span class="token operator">*</span> lstm_out<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># (batch_size, hidden_dim*2)</span>        output <span class="token operator">=</span> self<span class="token punctuation">.</span>fc<span class="token punctuation">(</span>context<span class="token punctuation">)</span>  <span class="token comment"># (batch_size, 1)</span>        output <span class="token operator">=</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>output<span class="token punctuation">)</span>        <span class="token keyword">return</span> output<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h4 id="模型训练"><a href="#模型训练" class="headerlink" title="模型训练"></a>模型训练</h4><ol><li><p>transformer</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">train_transformer_model</span><span class="token punctuation">(</span>X_train_seq<span class="token punctuation">,</span> y_train_seq<span class="token punctuation">,</span> X_val_seq<span class="token punctuation">,</span> y_val_seq<span class="token punctuation">,</span> input_dim<span class="token punctuation">,</span>                            nhead<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> num_encoder_layers<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> dim_feedforward<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> dropout<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span>                            epochs<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> patience<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    X_train_tensor <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>X_train_seq<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>    y_train_tensor <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>y_train_seq<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    X_val_tensor <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>X_val_seq<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>    y_val_tensor <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>y_val_seq<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    model <span class="token operator">=</span> TransformerClassifier<span class="token punctuation">(</span>input_dim<span class="token punctuation">,</span> nhead<span class="token punctuation">,</span> num_encoder_layers<span class="token punctuation">,</span> dim_feedforward<span class="token punctuation">,</span> dropout<span class="token punctuation">)</span>    criterion <span class="token operator">=</span> nn<span class="token punctuation">.</span>BCELoss<span class="token punctuation">(</span><span class="token punctuation">)</span>    optimizer <span class="token operator">=</span> optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">)</span>    best_val_loss <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'inf'</span><span class="token punctuation">)</span>    epochs_no_improve <span class="token operator">=</span> <span class="token number">0</span>    best_model_state <span class="token operator">=</span> <span class="token boolean">None</span>    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>        model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>        permutation <span class="token operator">=</span> torch<span class="token punctuation">.</span>randperm<span class="token punctuation">(</span>X_train_tensor<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        train_loss <span class="token operator">=</span> <span class="token number">0</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> X_train_tensor<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span><span class="token punctuation">:</span>            optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>            indices <span class="token operator">=</span> permutation<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i<span class="token operator">+</span>batch_size<span class="token punctuation">]</span>            batch_x <span class="token operator">=</span> X_train_tensor<span class="token punctuation">[</span>indices<span class="token punctuation">]</span>            batch_y <span class="token operator">=</span> y_train_tensor<span class="token punctuation">[</span>indices<span class="token punctuation">]</span>            outputs <span class="token operator">=</span> model<span class="token punctuation">(</span>batch_x<span class="token punctuation">)</span>            loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> batch_y<span class="token punctuation">)</span>            loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>            optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>            train_loss <span class="token operator">+=</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> batch_x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>        train_loss <span class="token operator">/=</span> X_train_tensor<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>        model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            val_outputs <span class="token operator">=</span> model<span class="token punctuation">(</span>X_val_tensor<span class="token punctuation">)</span>            val_loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>val_outputs<span class="token punctuation">,</span> y_val_tensor<span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> val_loss <span class="token operator">&lt;</span> best_val_loss<span class="token punctuation">:</span>            best_val_loss <span class="token operator">=</span> val_loss            best_model_state <span class="token operator">=</span> model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span>            epochs_no_improve <span class="token operator">=</span> <span class="token number">0</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            epochs_no_improve <span class="token operator">+=</span> <span class="token number">1</span>            <span class="token keyword">if</span> epochs_no_improve <span class="token operator">>=</span> patience<span class="token punctuation">:</span>                <span class="token keyword">break</span>    <span class="token keyword">if</span> best_model_state <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>        model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>best_model_state<span class="token punctuation">)</span>    model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        val_preds <span class="token operator">=</span> model<span class="token punctuation">(</span>X_val_tensor<span class="token punctuation">)</span>        val_preds_binary <span class="token operator">=</span> <span class="token punctuation">(</span>val_preds <span class="token operator">>=</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        accuracy <span class="token operator">=</span> <span class="token punctuation">(</span>val_preds_binary<span class="token punctuation">.</span>eq<span class="token punctuation">(</span>y_val_tensor<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> y_val_tensor<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> model<span class="token punctuation">,</span> accuracy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>BiLSTM+Attention</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">train_bilstm_attention_model</span><span class="token punctuation">(</span>X_train_seq<span class="token punctuation">,</span> y_train_seq<span class="token punctuation">,</span> X_val_seq<span class="token punctuation">,</span> y_val_seq<span class="token punctuation">,</span> input_dim<span class="token punctuation">,</span>                                 hidden_dim<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> epochs<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> patience<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    X_train_tensor <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>X_train_seq<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>    y_train_tensor <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>y_train_seq<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    X_val_tensor <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>X_val_seq<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>    y_val_tensor <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>y_val_seq<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    model <span class="token operator">=</span> BiLSTMAttention<span class="token punctuation">(</span>input_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">)</span>    criterion <span class="token operator">=</span> nn<span class="token punctuation">.</span>BCELoss<span class="token punctuation">(</span><span class="token punctuation">)</span>    optimizer <span class="token operator">=</span> optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">)</span>    best_val_loss <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'inf'</span><span class="token punctuation">)</span>    epochs_no_improve <span class="token operator">=</span> <span class="token number">0</span>    best_model_state <span class="token operator">=</span> <span class="token boolean">None</span>    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>        model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>        permutation <span class="token operator">=</span> torch<span class="token punctuation">.</span>randperm<span class="token punctuation">(</span>X_train_tensor<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        train_loss <span class="token operator">=</span> <span class="token number">0</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> X_train_tensor<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span><span class="token punctuation">:</span>            optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>            indices <span class="token operator">=</span> permutation<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i<span class="token operator">+</span>batch_size<span class="token punctuation">]</span>            batch_x <span class="token operator">=</span> X_train_tensor<span class="token punctuation">[</span>indices<span class="token punctuation">]</span>            batch_y <span class="token operator">=</span> y_train_tensor<span class="token punctuation">[</span>indices<span class="token punctuation">]</span>            outputs <span class="token operator">=</span> model<span class="token punctuation">(</span>batch_x<span class="token punctuation">)</span>            loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> batch_y<span class="token punctuation">)</span>            loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>            optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>            train_loss <span class="token operator">+=</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> batch_x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>        train_loss <span class="token operator">/=</span> X_train_tensor<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>        model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            val_outputs <span class="token operator">=</span> model<span class="token punctuation">(</span>X_val_tensor<span class="token punctuation">)</span>            val_loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>val_outputs<span class="token punctuation">,</span> y_val_tensor<span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> val_loss <span class="token operator">&lt;</span> best_val_loss<span class="token punctuation">:</span>            best_val_loss <span class="token operator">=</span> val_loss            best_model_state <span class="token operator">=</span> model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span>            epochs_no_improve <span class="token operator">=</span> <span class="token number">0</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            epochs_no_improve <span class="token operator">+=</span> <span class="token number">1</span>            <span class="token keyword">if</span> epochs_no_improve <span class="token operator">>=</span> patience<span class="token punctuation">:</span>                <span class="token keyword">break</span>    <span class="token keyword">if</span> best_model_state <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>        model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>best_model_state<span class="token punctuation">)</span>    model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        val_preds <span class="token operator">=</span> model<span class="token punctuation">(</span>X_val_tensor<span class="token punctuation">)</span>        val_preds_binary <span class="token operator">=</span> <span class="token punctuation">(</span>val_preds <span class="token operator">>=</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        accuracy <span class="token operator">=</span> <span class="token punctuation">(</span>val_preds_binary<span class="token punctuation">.</span>eq<span class="token punctuation">(</span>y_val_tensor<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> y_val_tensor<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> model<span class="token punctuation">,</span> accuracy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>辅助函数</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 辅助函数：构造序列数据</span><span class="token keyword">def</span> <span class="token function">create_sequences</span><span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">,</span> seq_length<span class="token punctuation">)</span><span class="token punctuation">:</span>    X_seq<span class="token punctuation">,</span> y_seq <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span> <span class="token operator">-</span> seq_length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        X_seq<span class="token punctuation">.</span>append<span class="token punctuation">(</span>X<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i<span class="token operator">+</span>seq_length<span class="token punctuation">]</span><span class="token punctuation">)</span>        y_seq<span class="token punctuation">.</span>append<span class="token punctuation">(</span>y<span class="token punctuation">[</span>i<span class="token operator">+</span>seq_length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>X_seq<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>y_seq<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h4 id="特征工程："><a href="#特征工程：" class="headerlink" title="特征工程："></a>特征工程：</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># ----------------------- 特征工程模块 -----------------------</span><span class="token keyword">def</span> <span class="token function">compute_features</span><span class="token punctuation">(</span>close_list<span class="token punctuation">,</span> volume_list<span class="token punctuation">,</span> prediction_window<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    构造特征数据，返回DataFrame，其中：      - close_list: 按时间顺序排列的收盘价列表（最早在前）      - volume_list: 成交量列表      - prediction_window: 预测窗口（未来N日）    """</span>    df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'close'</span><span class="token punctuation">:</span> close_list<span class="token punctuation">,</span> <span class="token string">'volume'</span><span class="token punctuation">:</span> volume_list<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    df<span class="token punctuation">[</span><span class="token string">'high'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span>    df<span class="token punctuation">[</span><span class="token string">'low'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span>    <span class="token comment"># 1. 滞后收益率</span>    <span class="token keyword">for</span> window <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">:</span>        df<span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'rtn_lag_</span><span class="token interpolation"><span class="token punctuation">&#123;</span>window<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pct_change<span class="token punctuation">(</span>window<span class="token punctuation">)</span>    <span class="token comment"># 2. 日收益率 &amp; 波动率</span>    df<span class="token punctuation">[</span><span class="token string">'daily_return'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pct_change<span class="token punctuation">(</span><span class="token punctuation">)</span>    df<span class="token punctuation">[</span><span class="token string">'volatility_10'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'daily_return'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span>std<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment"># 3. 均线及差值</span>    df<span class="token punctuation">[</span><span class="token string">'ma_20'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>    df<span class="token punctuation">[</span><span class="token string">'ma_diff'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'ma_20'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1e-8</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>    <span class="token comment"># 4. RSI（自定义与TA版本）</span>    delta <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>diff<span class="token punctuation">(</span><span class="token punctuation">)</span>    gain <span class="token operator">=</span> delta<span class="token punctuation">.</span>clip<span class="token punctuation">(</span>lower<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>    loss <span class="token operator">=</span> <span class="token operator">-</span>delta<span class="token punctuation">.</span>clip<span class="token punctuation">(</span>upper<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>    avg_gain <span class="token operator">=</span> gain<span class="token punctuation">.</span>rolling<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>    avg_loss <span class="token operator">=</span> loss<span class="token punctuation">.</span>rolling<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>    rs <span class="token operator">=</span> avg_gain <span class="token operator">/</span> <span class="token punctuation">(</span>avg_loss <span class="token operator">+</span> <span class="token number">1e-8</span><span class="token punctuation">)</span>    df<span class="token punctuation">[</span><span class="token string">'rsi_14_custom'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> rs<span class="token punctuation">)</span><span class="token punctuation">)</span>    df<span class="token punctuation">[</span><span class="token string">'ta_rsi'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ta<span class="token punctuation">.</span>RSI<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> timeperiod<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span>    <span class="token comment"># 5. MACD</span>    df<span class="token punctuation">[</span><span class="token string">'ema_12'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ewm<span class="token punctuation">(</span>span<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">,</span> adjust<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>    df<span class="token punctuation">[</span><span class="token string">'ema_26'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ewm<span class="token punctuation">(</span>span<span class="token operator">=</span><span class="token number">26</span><span class="token punctuation">,</span> adjust<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>    df<span class="token punctuation">[</span><span class="token string">'macd_custom'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'ema_12'</span><span class="token punctuation">]</span> <span class="token operator">-</span> df<span class="token punctuation">[</span><span class="token string">'ema_26'</span><span class="token punctuation">]</span>    df<span class="token punctuation">[</span><span class="token string">'macd_signal_custom'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'macd_custom'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ewm<span class="token punctuation">(</span>span<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">,</span> adjust<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>    df<span class="token punctuation">[</span><span class="token string">'macd_hist_custom'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'macd_custom'</span><span class="token punctuation">]</span> <span class="token operator">-</span> df<span class="token punctuation">[</span><span class="token string">'macd_signal_custom'</span><span class="token punctuation">]</span>    df<span class="token punctuation">[</span><span class="token string">'ta_macd'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'ta_macd_signal'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'ta_macd_hist'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ta<span class="token punctuation">.</span>MACD<span class="token punctuation">(</span>        df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> fastperiod<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">,</span> slowperiod<span class="token operator">=</span><span class="token number">26</span><span class="token punctuation">,</span> signalperiod<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">)</span>    <span class="token comment"># 6. Bollinger Bands</span>    df<span class="token punctuation">[</span><span class="token string">'ta_boll_upper'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'ta_boll_middle'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'ta_boll_lower'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ta<span class="token punctuation">.</span>BBANDS<span class="token punctuation">(</span>        df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> timeperiod<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span>    <span class="token comment"># 7. ADX</span>    df<span class="token punctuation">[</span><span class="token string">'ta_adx'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ta<span class="token punctuation">.</span>ADX<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'high'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'low'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> timeperiod<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span>    <span class="token comment"># 8. OBV</span>    df<span class="token punctuation">[</span><span class="token string">'ta_obv'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ta<span class="token punctuation">.</span>OBV<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'volume'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">)</span>    <span class="token comment"># 9. 慢速KD</span>    slowk<span class="token punctuation">,</span> slowd <span class="token operator">=</span> ta<span class="token punctuation">.</span>STOCH<span class="token punctuation">(</span>        df<span class="token punctuation">[</span><span class="token string">'high'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'low'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span>        fastk_period<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">,</span> slowk_period<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> slowk_matype<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>        slowd_period<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> slowd_matype<span class="token operator">=</span><span class="token number">0</span>    <span class="token punctuation">)</span>    df<span class="token punctuation">[</span><span class="token string">'ta_stoch_slowk'</span><span class="token punctuation">]</span> <span class="token operator">=</span> slowk    df<span class="token punctuation">[</span><span class="token string">'ta_stoch_slowd'</span><span class="token punctuation">]</span> <span class="token operator">=</span> slowd    <span class="token comment"># 10. CCI</span>    df<span class="token punctuation">[</span><span class="token string">'ta_cci'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ta<span class="token punctuation">.</span>CCI<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'high'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'low'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> timeperiod<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span>    <span class="token comment"># 11. Momentum</span>    df<span class="token punctuation">[</span><span class="token string">'ta_mom'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ta<span class="token punctuation">.</span>MOM<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> timeperiod<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>    <span class="token comment"># 12. ATR</span>    df<span class="token punctuation">[</span><span class="token string">'ta_atr'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ta<span class="token punctuation">.</span>ATR<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'high'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'low'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> timeperiod<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span>    <span class="token comment"># 13. MFI</span>    df<span class="token punctuation">[</span><span class="token string">'ta_mfi'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ta<span class="token punctuation">.</span>MFI<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'high'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'low'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span>                          df<span class="token punctuation">[</span><span class="token string">'volume'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> timeperiod<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span>    <span class="token comment"># 14. PPO</span>    df<span class="token punctuation">[</span><span class="token string">'ta_ppo'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ta<span class="token punctuation">.</span>PPO<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> fastperiod<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">,</span> slowperiod<span class="token operator">=</span><span class="token number">26</span><span class="token punctuation">,</span> matype<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>    <span class="token comment"># 15. ROC</span>    df<span class="token punctuation">[</span><span class="token string">'ta_roc'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ta<span class="token punctuation">.</span>ROC<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> timeperiod<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>    <span class="token comment"># 16. TRIX</span>    df<span class="token punctuation">[</span><span class="token string">'ta_trix'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ta<span class="token punctuation">.</span>TRIX<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> timeperiod<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">)</span>    <span class="token comment"># 17. Williams %R</span>    df<span class="token punctuation">[</span><span class="token string">'ta_willr'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ta<span class="token punctuation">.</span>WILLR<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'high'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'low'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> timeperiod<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span>    <span class="token comment"># 18. StochRSI</span>    df<span class="token punctuation">[</span><span class="token string">'ta_stochrsi'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ta<span class="token punctuation">.</span>STOCHRSI<span class="token punctuation">(</span>        df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> timeperiod<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">,</span>        fastk_period<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> fastd_period<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> fastd_matype<span class="token operator">=</span><span class="token number">0</span>    <span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    <span class="token comment"># 19. ULTOSC</span>    df<span class="token punctuation">[</span><span class="token string">'ta_ultosc'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ta<span class="token punctuation">.</span>ULTOSC<span class="token punctuation">(</span>        df<span class="token punctuation">[</span><span class="token string">'high'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'low'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span>        timeperiod1<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span> timeperiod2<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">,</span> timeperiod3<span class="token operator">=</span><span class="token number">28</span>    <span class="token punctuation">)</span>    <span class="token comment"># 20. Ichimoku</span>    <span class="token keyword">def</span> <span class="token function">compute_ichimoku</span><span class="token punctuation">(</span>high<span class="token punctuation">,</span> low<span class="token punctuation">)</span><span class="token punctuation">:</span>        high_series <span class="token operator">=</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span>high<span class="token punctuation">)</span>        low_series <span class="token operator">=</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span>low<span class="token punctuation">)</span>        tenkan <span class="token operator">=</span> <span class="token punctuation">(</span>high_series<span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> low_series<span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>        kijun <span class="token operator">=</span> <span class="token punctuation">(</span>high_series<span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span><span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> low_series<span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span><span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>        senkou_span_a <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tenkan <span class="token operator">+</span> kijun<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>shift<span class="token punctuation">(</span><span class="token number">26</span><span class="token punctuation">)</span>        senkou_span_b <span class="token operator">=</span> <span class="token punctuation">(</span>high_series<span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span><span class="token number">52</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> low_series<span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span><span class="token number">52</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>        senkou_span_b <span class="token operator">=</span> senkou_span_b<span class="token punctuation">.</span>shift<span class="token punctuation">(</span><span class="token number">26</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> tenkan<span class="token punctuation">,</span> kijun<span class="token punctuation">,</span> senkou_span_a<span class="token punctuation">,</span> senkou_span_b    tenkan<span class="token punctuation">,</span> kijun<span class="token punctuation">,</span> senkou_a<span class="token punctuation">,</span> senkou_b <span class="token operator">=</span> compute_ichimoku<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'high'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'low'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">)</span>    df<span class="token punctuation">[</span><span class="token string">'ichi_tenkan'</span><span class="token punctuation">]</span> <span class="token operator">=</span> tenkan    df<span class="token punctuation">[</span><span class="token string">'ichi_kijun'</span><span class="token punctuation">]</span> <span class="token operator">=</span> kijun    df<span class="token punctuation">[</span><span class="token string">'ichi_senkou_a'</span><span class="token punctuation">]</span> <span class="token operator">=</span> senkou_a    df<span class="token punctuation">[</span><span class="token string">'ichi_senkou_b'</span><span class="token punctuation">]</span> <span class="token operator">=</span> senkou_b    <span class="token comment"># 21. 未来N日累积涨跌幅（预测目标）</span>    df<span class="token punctuation">[</span><span class="token string">'cum_return_future'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pct_change<span class="token punctuation">(</span>periods<span class="token operator">=</span>prediction_window<span class="token punctuation">)</span><span class="token punctuation">.</span>shift<span class="token punctuation">(</span><span class="token operator">-</span>prediction_window<span class="token punctuation">)</span>    <span class="token comment"># 22. 52周range</span>    df<span class="token punctuation">[</span><span class="token string">'52w_high'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span><span class="token number">252</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    df<span class="token punctuation">[</span><span class="token string">'52w_low'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span><span class="token number">252</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    df<span class="token punctuation">[</span><span class="token string">'range_52w'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span> <span class="token operator">-</span> df<span class="token punctuation">[</span><span class="token string">'52w_low'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'52w_high'</span><span class="token punctuation">]</span> <span class="token operator">-</span> df<span class="token punctuation">[</span><span class="token string">'52w_low'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1e-8</span><span class="token punctuation">)</span>    <span class="token comment"># 23. PE (示例)</span>    df<span class="token punctuation">[</span><span class="token string">'pe'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">15</span>    <span class="token comment"># 24. 换手率</span>    df<span class="token punctuation">[</span><span class="token string">'vol_ma_20'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'volume'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>    df<span class="token punctuation">[</span><span class="token string">'turnover'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'volume'</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'vol_ma_20'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1e-8</span><span class="token punctuation">)</span>    <span class="token comment"># 标签：未来累计涨幅超过1%为正样本</span>    df<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'cum_return_future'</span><span class="token punctuation">]</span> <span class="token operator">></span> <span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>    df <span class="token operator">=</span> df<span class="token punctuation">.</span>fillna<span class="token punctuation">(</span>method<span class="token operator">=</span><span class="token string">'ffill'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fillna<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>    feature_cols <span class="token operator">=</span> <span class="token punctuation">[</span>col <span class="token keyword">for</span> col <span class="token keyword">in</span> df<span class="token punctuation">.</span>columns <span class="token keyword">if</span> col <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">,</span> <span class="token string">'cum_return_future'</span><span class="token punctuation">,</span> <span class="token string">'daily_return'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>    df <span class="token operator">=</span> df<span class="token punctuation">[</span>feature_cols <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">,</span> <span class="token string">'cum_return_future'</span><span class="token punctuation">,</span> <span class="token string">'daily_return'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>    df <span class="token operator">=</span> df<span class="token punctuation">.</span>fillna<span class="token punctuation">(</span>method<span class="token operator">=</span><span class="token string">'ffill'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fillna<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> df<span class="token punctuation">,</span> feature_cols<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>特征上用到都是比较基础统计类的特征，时序相关的还没开，实际上如果开发时序类特征，lstm+transformer的效果会好很多</p><h4 id="主程序"><a href="#主程序" class="headerlink" title="主程序"></a>主程序</h4><p>策略上就是止盈止损+一些回撤止盈，比较简单就不写了，然后下面是代码主入口</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># ----------------------- 主程序 -----------------------</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    cerebro <span class="token operator">=</span> bt<span class="token punctuation">.</span>Cerebro<span class="token punctuation">(</span><span class="token punctuation">)</span>    symbol <span class="token operator">=</span> <span class="token string">'600519'</span>    stock_data <span class="token operator">=</span> fetch_akshare_data<span class="token punctuation">(</span>        symbol<span class="token operator">=</span>symbol<span class="token punctuation">,</span>        start_date<span class="token operator">=</span>pd<span class="token punctuation">.</span>to_datetime<span class="token punctuation">(</span><span class="token string">'2018-01-01'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        end_date<span class="token operator">=</span>pd<span class="token punctuation">.</span>to_datetime<span class="token punctuation">(</span><span class="token string">'2025-03-01'</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span>    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"\n[数据样例]"</span><span class="token punctuation">)</span>    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span>stock_data<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\n数据时间范围: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>stock_data<span class="token punctuation">.</span>index<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string"> ~ </span><span class="token interpolation"><span class="token punctuation">&#123;</span>stock_data<span class="token punctuation">.</span>index<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>    data <span class="token operator">=</span> bt<span class="token punctuation">.</span>feeds<span class="token punctuation">.</span>PandasData<span class="token punctuation">(</span>        dataname<span class="token operator">=</span>stock_data<span class="token punctuation">,</span>        <span class="token builtin">open</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> high<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> low<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> close<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> volume<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> openinterest<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span>    <span class="token punctuation">)</span>    cerebro<span class="token punctuation">.</span>adddata<span class="token punctuation">(</span>data<span class="token punctuation">)</span>    cerebro<span class="token punctuation">.</span>addstrategy<span class="token punctuation">(</span>        MLStrategy<span class="token punctuation">,</span>        training_period<span class="token operator">=</span><span class="token number">504</span><span class="token punctuation">,</span>        prediction_window<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>        probability_threshold<span class="token operator">=</span><span class="token number">0.65</span><span class="token punctuation">,</span>    <span class="token punctuation">)</span>    cerebro<span class="token punctuation">.</span>broker<span class="token punctuation">.</span>setcash<span class="token punctuation">(</span><span class="token number">1_000_000</span><span class="token punctuation">)</span>    cerebro<span class="token punctuation">.</span>broker<span class="token punctuation">.</span>setcommission<span class="token punctuation">(</span>commission<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">)</span>    cerebro<span class="token punctuation">.</span>addanalyzer<span class="token punctuation">(</span>bt<span class="token punctuation">.</span>analyzers<span class="token punctuation">.</span>PyFolio<span class="token punctuation">,</span> _name<span class="token operator">=</span><span class="token string">'pyfolio'</span><span class="token punctuation">)</span>    cerebro<span class="token punctuation">.</span>addanalyzer<span class="token punctuation">(</span>bt<span class="token punctuation">.</span>analyzers<span class="token punctuation">.</span>SharpeRatio<span class="token punctuation">,</span> riskfreerate<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">,</span> annualize<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>                        timeframe<span class="token operator">=</span>bt<span class="token punctuation">.</span>TimeFrame<span class="token punctuation">.</span>Days<span class="token punctuation">,</span> _name<span class="token operator">=</span><span class="token string">'sharpe'</span><span class="token punctuation">)</span>    cerebro<span class="token punctuation">.</span>addanalyzer<span class="token punctuation">(</span>bt<span class="token punctuation">.</span>analyzers<span class="token punctuation">.</span>DrawDown<span class="token punctuation">,</span> _name<span class="token operator">=</span><span class="token string">'drawdown'</span><span class="token punctuation">)</span>    cerebro<span class="token punctuation">.</span>addanalyzer<span class="token punctuation">(</span>bt<span class="token punctuation">.</span>analyzers<span class="token punctuation">.</span>TradeAnalyzer<span class="token punctuation">,</span> _name<span class="token operator">=</span><span class="token string">'trade_analyzer'</span><span class="token punctuation">)</span>    cerebro<span class="token punctuation">.</span>addanalyzer<span class="token punctuation">(</span>bt<span class="token punctuation">.</span>analyzers<span class="token punctuation">.</span>TimeReturn<span class="token punctuation">,</span> timeframe<span class="token operator">=</span>bt<span class="token punctuation">.</span>TimeFrame<span class="token punctuation">.</span>Days<span class="token punctuation">,</span> _name<span class="token operator">=</span><span class="token string">'time_return'</span><span class="token punctuation">)</span>    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"\n启动回测..."</span><span class="token punctuation">)</span>    results <span class="token operator">=</span> cerebro<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>    strat <span class="token operator">=</span> results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    final_value <span class="token operator">=</span> cerebro<span class="token punctuation">.</span>broker<span class="token punctuation">.</span>getvalue<span class="token punctuation">(</span><span class="token punctuation">)</span>    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\n最终资金: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>final_value<span class="token punctuation">:</span><span class="token format-spec">,.2f</span><span class="token punctuation">&#125;</span></span><span class="token string"> CNY"</span></span><span class="token punctuation">)</span>    sharpe <span class="token operator">=</span> strat<span class="token punctuation">.</span>analyzers<span class="token punctuation">.</span>sharpe<span class="token punctuation">.</span>get_analysis<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> sharpe<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'sharperatio'</span><span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"年化夏普比率: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>sharpe<span class="token punctuation">[</span><span class="token string">'sharperatio'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"年化夏普比率: N/A"</span><span class="token punctuation">)</span>    drawdown <span class="token operator">=</span> strat<span class="token punctuation">.</span>analyzers<span class="token punctuation">.</span>drawdown<span class="token punctuation">.</span>get_analysis<span class="token punctuation">(</span><span class="token punctuation">)</span>    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"最大回撤: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>drawdown<span class="token punctuation">[</span><span class="token string">'max'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'drawdown'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">&#125;</span></span><span class="token string">% (持续 </span><span class="token interpolation"><span class="token punctuation">&#123;</span>drawdown<span class="token punctuation">[</span><span class="token string">'max'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'len'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></span><span class="token string"> 天)"</span></span><span class="token punctuation">)</span>    trade_analyzer <span class="token operator">=</span> strat<span class="token punctuation">.</span>analyzers<span class="token punctuation">.</span>trade_analyzer<span class="token punctuation">.</span>get_analysis<span class="token punctuation">(</span><span class="token punctuation">)</span>    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"\n交易统计: %s"</span><span class="token punctuation">,</span> trade_analyzer<span class="token punctuation">)</span>    time_return <span class="token operator">=</span> strat<span class="token punctuation">.</span>analyzers<span class="token punctuation">.</span>time_return<span class="token punctuation">.</span>get_analysis<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>time_return<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>        daily_returns <span class="token operator">=</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span>time_return<span class="token punctuation">)</span>        total_ret <span class="token operator">=</span> <span class="token punctuation">(</span>daily_returns <span class="token operator">+</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>prod<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1.0</span>        days <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>daily_returns<span class="token punctuation">)</span>        annual_ret <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> total_ret<span class="token punctuation">)</span><span class="token operator">**</span><span class="token punctuation">(</span><span class="token number">252</span><span class="token operator">/</span>days<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token keyword">if</span> days <span class="token operator">></span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token boolean">None</span>        <span class="token keyword">if</span> annual_ret <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>            logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"年化收益率: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>annual_ret<span class="token punctuation">:</span><span class="token format-spec">.2%</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"无法计算年化收益率"</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"time_return结果为空，无法计算年化收益率"</span><span class="token punctuation">)</span>    figs <span class="token operator">=</span> cerebro<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>style<span class="token operator">=</span><span class="token string">'candlestick'</span><span class="token punctuation">,</span> volume<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> barup<span class="token operator">=</span><span class="token string">'red'</span><span class="token punctuation">,</span> bardown<span class="token operator">=</span><span class="token string">'green'</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> figs <span class="token keyword">and</span> figs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>        fig <span class="token operator">=</span> figs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>        fig<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span><span class="token string">"backtrader_plot.png"</span><span class="token punctuation">)</span>        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"图形已保存为 backtrader_plot.png"</span><span class="token punctuation">)</span>    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="下一步计划"><a href="#下一步计划" class="headerlink" title="下一步计划"></a>下一步计划</h3><ol><li>构造特征要加强，要筛选出更多的因子，这次只是实验，所以因子挑选的比较简单</li><li>模型结构可以调整一下，深度和注意力可以加多</li><li>gnn再尝试一下，板块内部的股票实际上是有关联的</li></ol><p>当然这个代码非常粗糙，仅作为学习记录，如果有建议和不足请大家指正</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h3&gt;&lt;p&gt;最近在港股美股上的收益还可以，但是在择时能力上感觉靠人的判断没有特别的准确，希望通过量化的方式去帮助择时，也不希望做高频，只希望高抛低吸做t</summary>
      
    
    
    
    <category term="技术文章" scheme="https://miaohancheng.github.io/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E7%AB%A0/"/>
    
    <category term="投资" scheme="https://miaohancheng.github.io/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E7%AB%A0/%E6%8A%95%E8%B5%84/"/>
    
    
    <category term="deep learning" scheme="https://miaohancheng.github.io/tags/deep-learning/"/>
    
    <category term="python" scheme="https://miaohancheng.github.io/tags/python/"/>
    
    <category term="machine learning" scheme="https://miaohancheng.github.io/tags/machine-learning/"/>
    
    <category term="quant trading" scheme="https://miaohancheng.github.io/tags/quant-trading/"/>
    
  </entry>
  
  <entry>
    <title>美国绿卡流程记录</title>
    <link href="https://miaohancheng.github.io/2024/12/01/%E7%BE%8E%E5%9B%BD%E7%BB%BF%E5%8D%A1%E6%B5%81%E7%A8%8B%E8%AE%B0%E5%BD%95/"/>
    <id>https://miaohancheng.github.io/2024/12/01/%E7%BE%8E%E5%9B%BD%E7%BB%BF%E5%8D%A1%E6%B5%81%E7%A8%8B%E8%AE%B0%E5%BD%95/</id>
    <published>2024-12-01T21:00:00.000Z</published>
    <updated>2025-03-10T08:02:51.530Z</updated>
    
    <content type="html"><![CDATA[<h3 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h3><p>主要介绍一下我在国内申请NIW，从开始准备材料到美国移民局通过审核的所有流程，现在排期还未排到，如果排到之后再更新面试、拿卡等流程。</p><h3 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h3><p>主要是因为covid-19的封控问题，导致想换个国家生活工作一段时间，但是已经错过了留学留在国外工作的时间，而美国公司直接招聘海外员工发放h1b的情况又比较少；</p><p>其实可行的路就剩下两条：</p><ol><li>国内直接找到可以rebase到海外的外企，比如google、amd这些</li><li>国内直接申请绿卡，拿到卡之后出去</li></ol><h3 id="准备申请"><a href="#准备申请" class="headerlink" title="准备申请"></a>准备申请</h3><h4 id="前期调研"><a href="#前期调研" class="headerlink" title="前期调研"></a>前期调研</h4><p>首先查询了相关案例，发现有NIW、EB1A 两条路可以直接人在美国境外申请绿卡（无需雇主担保），两个要求、排期各不相同，两种类型具体介绍如下：</p><ul><li><p><a href="https://zhuanlan.zhihu.com/p/652960567?zpf=1695417255872118784">NIW</a> (这个介绍也算是广告，大家自行甄别)</p></li><li><p><a href="https://zhuanlan.zhihu.com/p/578761321">EB1A</a>(这个介绍也算是广告，大家自行甄别)</p></li></ul><p>一开始是准备DIY，然后找了一个美国的移民律师咨询了NIW、EB1A等情况，咨询费200美元&#x2F;小时；</p><p>发现自己的情况在NIW的条件下勉强及格，EB1A的话目前还不达标，所以放弃了EB1A，专心搞NIW；</p><h4 id="寻找中介"><a href="#寻找中介" class="headerlink" title="寻找中介"></a>寻找中介</h4><p>我和律师发现自己申请材料的缺陷主要是两点，一个是美国相关的专业人士推荐信不够；另外是行业内的影响力不够，这点靠自己DIY比较困难，所以还是想了下决定找中介来做这个项目；</p><p>知乎、搜索之类的加了好几个中介，发了多份材料之后，选定了一个中介来帮我找到律师写整个申请材料；</p><p>其中自己要准备的材料非常多，下面列举一些：</p><ol><li>薪资收入证明</li><li>在职证明</li><li>学历信息证明</li><li>专利信息</li><li>各种行业相关证书</li><li>新闻稿和发表论文等</li></ol><p>整体准备材料到律师完成，递交给美国移民局 耗时：10个月，其中因为疫情上海封控了一段时间，一般也是需要半年左右，很多材料可能手头都没有，还要去找和去学校、公司开具；</p><h3 id="移民局审核"><a href="#移民局审核" class="headerlink" title="移民局审核"></a>移民局审核</h3><p>在律师完成所有的文件翻译、审核、校对之后，要求付清翻译费之类的费用，会直接帮我递交材料</p><p>递交时间：2023-4</p><img src="https://github.com/miaohancheng/picx-images-hosting/raw/master/pics/niw-recipet.wilm8fufg.jpg" alt="递件凭证" style="zoom:33%;" /><p>中介反馈一般审批时间是半年左右</p><p>等到了2023-9，收到了获批函，证明我的NIW申请第一步已经基本完成，后续等待排期；</p><h3 id="等待排期"><a href="#等待排期" class="headerlink" title="等待排期"></a>等待排期</h3><p>等待排期是比较漫长的，主要是没什么进展，一年可能就前进6个月左右；</p><p>现在每晚1年申请绿卡，就要晚2年拿到。</p><p>查看排期的比较好用的网站推荐：<a href="https://visa.careerengine.us/">https://visa.careerengine.us/</a> （可以自己定好自己的pd）</p><p><img src="https://github.com/miaohancheng/picx-images-hosting/raw/master/pics/%E6%8E%92%E6%9C%9F%E8%A1%A8.73tzmehatm.jpg" alt="排期表"></p><h3 id="待更新后续"><a href="#待更新后续" class="headerlink" title="待更新后续"></a>待更新后续</h3><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>这个总体项目还是比较长的，建议大家如果有打算要尽早行动，早做准备。</p><p>同时也是耗时耗精力，还会有很多意外、补充材料的情况。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;摘要&quot;&gt;&lt;a href=&quot;#摘要&quot; class=&quot;headerlink&quot; title=&quot;摘要&quot;&gt;&lt;/a&gt;摘要&lt;/h3&gt;&lt;p&gt;主要介绍一下我在国内申请NIW，从开始准备材料到美国移民局通过审核的所有流程，现在排期还未排到，如果排到之后再更新面试、拿卡等流程。&lt;/p&gt;</summary>
      
    
    
    
    <category term="留学移民" scheme="https://miaohancheng.github.io/categories/%E7%95%99%E5%AD%A6%E7%A7%BB%E6%B0%91/"/>
    
    
    <category term="NIW" scheme="https://miaohancheng.github.io/tags/NIW/"/>
    
    <category term="美国绿卡" scheme="https://miaohancheng.github.io/tags/%E7%BE%8E%E5%9B%BD%E7%BB%BF%E5%8D%A1/"/>
    
  </entry>
  
  <entry>
    <title>多语言NER模型微调</title>
    <link href="https://miaohancheng.github.io/2024/11/29/%E5%A4%9A%E8%AF%AD%E8%A8%80NER%E6%A8%A1%E5%9E%8B%E5%BE%AE%E8%B0%83/"/>
    <id>https://miaohancheng.github.io/2024/11/29/%E5%A4%9A%E8%AF%AD%E8%A8%80NER%E6%A8%A1%E5%9E%8B%E5%BE%AE%E8%B0%83/</id>
    <published>2024-11-29T15:00:00.000Z</published>
    <updated>2025-03-10T08:02:51.529Z</updated>
    
    <content type="html"><![CDATA[<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>工作中有遇到多语言的地址、短句等数据，需要标注出其中人名、快递公司、电话等信息，现有的开源数据集中这部分数据较少，主要问题是要自己构建对应的数据集、以及对于开源通过wiki训练的模型要尽可能保留训练的经验</p><h3 id="模型选取"><a href="#模型选取" class="headerlink" title="模型选取"></a>模型选取</h3><p>选择了RoBERTa基于 <a href="https://huggingface.co/datasets/unimelb-nlp/wikiann"><strong>wikiann</strong></a> 预训练的模型 <a href="https://huggingface.co/julian-schelb/roberta-ner-multilingual"><strong>roberta-ner-multilingual</strong></a>，对于现实中的知识已经有一部分理解，但是对于地址等信息知识较少需要额外训练；</p><p>最原始的基座模型是facebook的 <a href="https://huggingface.co/FacebookAI/xlm-roberta-large"><strong>xlm-roberta-large</strong></a></p><h3 id="数据准备"><a href="#数据准备" class="headerlink" title="数据准备"></a>数据准备</h3><p>准备了训练和测试数据集放在了 <code>./data</code>目录下，数据大致格式如下</p><pre class="line-numbers language-json" data-language="json"><code class="language-json">John    B-PERlives   Oin      OBerlin  B-LOC.      O他      O住      O在      O北京    B-LOC。      O<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过不同的标签定义不同的实体，在模型训练中可以通过单一语言的样本迁移一部分知识到其他语言，这也是多语言模型的一个优势。</p><h3 id="模型加载"><a href="#模型加载" class="headerlink" title="模型加载"></a>模型加载</h3><p>因为我在本机mac上训练，后续迁移到服务器上，所以写了判断设备的代码</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> torch<span class="token keyword">from</span> transformers <span class="token keyword">import</span> AutoTokenizer<span class="token punctuation">,</span> AutoModelForTokenClassification<span class="token punctuation">,</span> Trainer<span class="token punctuation">,</span> TrainingArguments<span class="token keyword">from</span> transformers <span class="token keyword">import</span> DataCollatorForTokenClassification<span class="token keyword">from</span> datasets <span class="token keyword">import</span> Dataset<span class="token punctuation">,</span> DatasetDict<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np<span class="token keyword">import</span> evaluate<span class="token keyword">from</span> torch <span class="token keyword">import</span> nn<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> Fdevice <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">'cuda'</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">'cpu'</span><span class="token punctuation">)</span><span class="token comment"># 确定设备</span><span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">'cuda'</span><span class="token punctuation">)</span><span class="token keyword">elif</span> torch<span class="token punctuation">.</span>backends<span class="token punctuation">.</span>mps<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">'mps'</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">'cpu'</span><span class="token punctuation">)</span><span class="token comment"># 加载分词器和模型</span>tokenizer <span class="token operator">=</span> AutoTokenizer<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span><span class="token string">"julian-schelb/roberta-ner-multilingual"</span><span class="token punctuation">,</span> add_prefix_space<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>model <span class="token operator">=</span> AutoModelForTokenClassification<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span><span class="token string">"julian-schelb/roberta-ner-multilingual"</span><span class="token punctuation">)</span>model<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>  <span class="token comment"># 将模型移动到设备</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="增加标签"><a href="#增加标签" class="headerlink" title="增加标签"></a>增加标签</h3><p>原有的模型中标签类别较少，如果有新的标签可以手动添加</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 如果有新标签，更新标签列表和映射</span>original_labels <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>config<span class="token punctuation">.</span>id2label<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>new_labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'B-FACILITY'</span><span class="token punctuation">,</span><span class="token string">'I-FACILITY'</span> <span class="token punctuation">]</span> <span class="token comment"># 加入你新的标签即可</span>label_list <span class="token operator">=</span> original_labels <span class="token operator">+</span> new_labelslabel_to_id <span class="token operator">=</span> <span class="token punctuation">&#123;</span>label<span class="token punctuation">:</span> idx <span class="token keyword">for</span> idx<span class="token punctuation">,</span> label <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>label_list<span class="token punctuation">)</span><span class="token punctuation">&#125;</span>id_to_label <span class="token operator">=</span> <span class="token punctuation">&#123;</span>idx<span class="token punctuation">:</span> label <span class="token keyword">for</span> idx<span class="token punctuation">,</span> label <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>label_list<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>更新模型配置</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 更新模型配置</span>model<span class="token punctuation">.</span>config<span class="token punctuation">.</span>num_labels <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>label_list<span class="token punctuation">)</span>model<span class="token punctuation">.</span>config<span class="token punctuation">.</span>id2label <span class="token operator">=</span> id_to_labelmodel<span class="token punctuation">.</span>config<span class="token punctuation">.</span>label2id <span class="token operator">=</span> label_to_id<span class="token comment"># 替换分类层</span>model<span class="token punctuation">.</span>classifier <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>model<span class="token punctuation">.</span>config<span class="token punctuation">.</span>hidden_size<span class="token punctuation">,</span> model<span class="token punctuation">.</span>config<span class="token punctuation">.</span>num_labels<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="教师模型"><a href="#教师模型" class="headerlink" title="教师模型"></a>教师模型</h3><p>希望模型在学习新知识的前提下，不要遗忘旧知识，所以再增加一个教师模型来做监督</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 加载教师模型</span>teacher_model <span class="token operator">=</span> AutoModelForTokenClassification<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span><span class="token string">"julian-schelb/roberta-ner-multilingual"</span><span class="token punctuation">)</span>teacher_model<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>  <span class="token comment"># 将教师模型移动到设备</span>teacher_model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># 可选：冻结学生模型的部分层</span><span class="token keyword">for</span> name<span class="token punctuation">,</span> param <span class="token keyword">in</span> model<span class="token punctuation">.</span>named_parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> name<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'roberta.embeddings'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> name<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'roberta.encoder.layer.0'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> name<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'roberta.encoder.layer.1'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        param<span class="token punctuation">.</span>requires_grad <span class="token operator">=</span> <span class="token boolean">False</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="加载数据"><a href="#加载数据" class="headerlink" title="加载数据"></a>加载数据</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 定义读取数据的函数</span><span class="token keyword">def</span> <span class="token function">read_conll_data</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">:</span>    tokens <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    ner_tags <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>        words <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        tags <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        <span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">:</span>            line <span class="token operator">=</span> line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> <span class="token keyword">not</span> line<span class="token punctuation">:</span>                <span class="token keyword">if</span> words<span class="token punctuation">:</span>                    tokens<span class="token punctuation">.</span>append<span class="token punctuation">(</span>words<span class="token punctuation">)</span>                    ner_tags<span class="token punctuation">.</span>append<span class="token punctuation">(</span>tags<span class="token punctuation">)</span>                    words <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>                    tags <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                splits <span class="token operator">=</span> line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>splits<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">2</span><span class="token punctuation">:</span>                    words<span class="token punctuation">.</span>append<span class="token punctuation">(</span>splits<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                    tags<span class="token punctuation">.</span>append<span class="token punctuation">(</span>splits<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> words<span class="token punctuation">:</span>            tokens<span class="token punctuation">.</span>append<span class="token punctuation">(</span>words<span class="token punctuation">)</span>            ner_tags<span class="token punctuation">.</span>append<span class="token punctuation">(</span>tags<span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">'tokens'</span><span class="token punctuation">:</span> tokens<span class="token punctuation">,</span> <span class="token string">'ner_tags'</span><span class="token punctuation">:</span> ner_tags<span class="token punctuation">&#125;</span><span class="token comment"># 加载您的数据</span>train_data <span class="token operator">=</span> read_conll_data<span class="token punctuation">(</span><span class="token string">'./data/train.txt'</span><span class="token punctuation">)</span>validation_data <span class="token operator">=</span> read_conll_data<span class="token punctuation">(</span><span class="token string">'./data/validation.txt'</span><span class="token punctuation">)</span>train_dataset <span class="token operator">=</span> Dataset<span class="token punctuation">.</span>from_dict<span class="token punctuation">(</span>train_data<span class="token punctuation">)</span>validation_dataset <span class="token operator">=</span> Dataset<span class="token punctuation">.</span>from_dict<span class="token punctuation">(</span>validation_data<span class="token punctuation">)</span><span class="token comment"># 创建数据集对象</span>datasets <span class="token operator">=</span> DatasetDict<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'train'</span><span class="token punctuation">:</span> train_dataset<span class="token punctuation">,</span> <span class="token string">'validation'</span><span class="token punctuation">:</span> validation_dataset<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="数据预处理"><a href="#数据预处理" class="headerlink" title="数据预处理"></a>数据预处理</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 定义数据预处理函数</span><span class="token keyword">def</span> <span class="token function">tokenize_and_align_labels</span><span class="token punctuation">(</span>examples<span class="token punctuation">)</span><span class="token punctuation">:</span>    tokenized_inputs <span class="token operator">=</span> tokenizer<span class="token punctuation">(</span>        examples<span class="token punctuation">[</span><span class="token string">'tokens'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        truncation<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>        is_split_into_words<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>        padding<span class="token operator">=</span><span class="token string">'longest'</span><span class="token punctuation">,</span>  <span class="token comment"># 启用填充</span>        max_length<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">,</span>     <span class="token comment"># 可根据需要调整</span>    <span class="token punctuation">)</span>    labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>tokenized_inputs<span class="token punctuation">[</span><span class="token string">'input_ids'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        word_ids <span class="token operator">=</span> tokenized_inputs<span class="token punctuation">.</span>word_ids<span class="token punctuation">(</span>batch_index<span class="token operator">=</span>i<span class="token punctuation">)</span>        label_ids <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        previous_word_idx <span class="token operator">=</span> <span class="token boolean">None</span>        <span class="token keyword">for</span> word_idx <span class="token keyword">in</span> word_ids<span class="token punctuation">:</span>            <span class="token keyword">if</span> word_idx <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>                label_ids<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">100</span><span class="token punctuation">)</span>            <span class="token keyword">elif</span> word_idx <span class="token operator">!=</span> previous_word_idx<span class="token punctuation">:</span>                label_ids<span class="token punctuation">.</span>append<span class="token punctuation">(</span>label_to_id<span class="token punctuation">.</span>get<span class="token punctuation">(</span>examples<span class="token punctuation">[</span><span class="token string">'ner_tags'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>word_idx<span class="token punctuation">]</span><span class="token punctuation">,</span> label_to_id<span class="token punctuation">[</span><span class="token string">'O'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                label_ids<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">100</span><span class="token punctuation">)</span>            previous_word_idx <span class="token operator">=</span> word_idx        labels<span class="token punctuation">.</span>append<span class="token punctuation">(</span>label_ids<span class="token punctuation">)</span>    tokenized_inputs<span class="token punctuation">[</span><span class="token string">'labels'</span><span class="token punctuation">]</span> <span class="token operator">=</span> labels    <span class="token keyword">return</span> tokenized_inputs<span class="token comment"># 预处理数据</span>tokenized_datasets <span class="token operator">=</span> datasets<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>tokenize_and_align_labels<span class="token punctuation">,</span> batched<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="评估指标"><a href="#评估指标" class="headerlink" title="评估指标"></a>评估指标</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 加载评估指标</span>metric <span class="token operator">=</span> evaluate<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">'seqeval'</span><span class="token punctuation">)</span><span class="token comment"># 定义评估函数</span><span class="token keyword">def</span> <span class="token function">compute_metrics</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">:</span>    predictions<span class="token punctuation">,</span> labels <span class="token operator">=</span> p    predictions <span class="token operator">=</span> np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>predictions<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>    true_labels <span class="token operator">=</span> <span class="token punctuation">[</span>        <span class="token punctuation">[</span>label_list<span class="token punctuation">[</span>l<span class="token punctuation">]</span> <span class="token keyword">for</span> l <span class="token keyword">in</span> label <span class="token keyword">if</span> l <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">100</span><span class="token punctuation">]</span>        <span class="token keyword">for</span> label <span class="token keyword">in</span> labels    <span class="token punctuation">]</span>    true_predictions <span class="token operator">=</span> <span class="token punctuation">[</span>        <span class="token punctuation">[</span>label_list<span class="token punctuation">[</span>pred<span class="token punctuation">]</span> <span class="token keyword">for</span> <span class="token punctuation">(</span>pred<span class="token punctuation">,</span> lab<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>prediction<span class="token punctuation">,</span> label<span class="token punctuation">)</span> <span class="token keyword">if</span> lab <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">100</span><span class="token punctuation">]</span>        <span class="token keyword">for</span> prediction<span class="token punctuation">,</span> label <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>predictions<span class="token punctuation">,</span> labels<span class="token punctuation">)</span>    <span class="token punctuation">]</span>    results <span class="token operator">=</span> metric<span class="token punctuation">.</span>compute<span class="token punctuation">(</span>predictions<span class="token operator">=</span>true_predictions<span class="token punctuation">,</span> references<span class="token operator">=</span>true_labels<span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>        <span class="token string">'precision'</span><span class="token punctuation">:</span> results<span class="token punctuation">[</span><span class="token string">'overall_precision'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token string">'recall'</span><span class="token punctuation">:</span> results<span class="token punctuation">[</span><span class="token string">'overall_recall'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token string">'f1'</span><span class="token punctuation">:</span> results<span class="token punctuation">[</span><span class="token string">'overall_f1'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token string">'accuracy'</span><span class="token punctuation">:</span> results<span class="token punctuation">[</span><span class="token string">'overall_accuracy'</span><span class="token punctuation">]</span>    <span class="token punctuation">&#125;</span><span class="token comment"># 定义 DataCollator</span>data_collator <span class="token operator">=</span> DataCollatorForTokenClassification<span class="token punctuation">(</span>    tokenizer<span class="token punctuation">,</span>    padding<span class="token operator">=</span><span class="token string">'longest'</span><span class="token punctuation">,</span>    max_length<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">,</span>    return_tensors<span class="token operator">=</span><span class="token string">'pt'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="定义trainer"><a href="#定义trainer" class="headerlink" title="定义trainer"></a>定义trainer</h3><p>因为要做知识蒸馏，所以需要自定义trainer，结合教师模型的结果来做损失判定</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 定义自定义 Trainer，用于知识蒸馏</span><span class="token keyword">class</span> <span class="token class-name">DistillationTrainer</span><span class="token punctuation">(</span>Trainer<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> teacher_model<span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">2.0</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>teacher_model <span class="token operator">=</span> teacher_model        self<span class="token punctuation">.</span>temperature <span class="token operator">=</span> temperature        self<span class="token punctuation">.</span>alpha <span class="token operator">=</span> alpha        self<span class="token punctuation">.</span>teacher_model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">compute_loss</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> model<span class="token punctuation">,</span> inputs<span class="token punctuation">,</span> return_outputs<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>        labels <span class="token operator">=</span> inputs<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">"labels"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>        <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> inputs<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            inputs<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>        outputs <span class="token operator">=</span> model<span class="token punctuation">(</span><span class="token operator">**</span>inputs<span class="token punctuation">)</span>        student_logits <span class="token operator">=</span> outputs<span class="token punctuation">.</span>logits        <span class="token comment"># 计算学生模型的损失（交叉熵损失）</span>        loss_fct <span class="token operator">=</span> nn<span class="token punctuation">.</span>CrossEntropyLoss<span class="token punctuation">(</span><span class="token punctuation">)</span>        active_loss <span class="token operator">=</span> labels<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">100</span>        active_logits <span class="token operator">=</span> student_logits<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>config<span class="token punctuation">.</span>num_labels<span class="token punctuation">)</span><span class="token punctuation">[</span>active_loss<span class="token punctuation">]</span>        active_labels <span class="token operator">=</span> labels<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span>active_loss<span class="token punctuation">]</span>        student_loss <span class="token operator">=</span> loss_fct<span class="token punctuation">(</span>active_logits<span class="token punctuation">,</span> active_labels<span class="token punctuation">)</span>        <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            teacher_outputs <span class="token operator">=</span> self<span class="token punctuation">.</span>teacher_model<span class="token punctuation">(</span><span class="token operator">**</span>inputs<span class="token punctuation">)</span>            teacher_logits <span class="token operator">=</span> teacher_outputs<span class="token punctuation">.</span>logits        <span class="token comment"># 提取学生模型中对应于原始标签的 logits</span>        num_labels_teacher <span class="token operator">=</span> teacher_logits<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 7</span>        student_logits_for_kd <span class="token operator">=</span> student_logits<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span>num_labels_teacher<span class="token punctuation">]</span>        <span class="token comment"># 计算蒸馏损失（KL 散度）</span>        loss_fct <span class="token operator">=</span> nn<span class="token punctuation">.</span>KLDivLoss<span class="token punctuation">(</span>reduction<span class="token operator">=</span><span class="token string">'batchmean'</span><span class="token punctuation">)</span>        student_logits_temp <span class="token operator">=</span> student_logits_for_kd <span class="token operator">/</span> self<span class="token punctuation">.</span>temperature        teacher_logits_temp <span class="token operator">=</span> teacher_logits <span class="token operator">/</span> self<span class="token punctuation">.</span>temperature        distillation_loss <span class="token operator">=</span> loss_fct<span class="token punctuation">(</span>            F<span class="token punctuation">.</span>log_softmax<span class="token punctuation">(</span>student_logits_temp<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            F<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>teacher_logits_temp<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>temperature <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Student logits shape:"</span><span class="token punctuation">,</span> student_logits<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Teacher logits shape:"</span><span class="token punctuation">,</span> teacher_logits<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Student logits for KD shape:"</span><span class="token punctuation">,</span> student_logits_for_kd<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>        <span class="token comment"># 合并损失</span>        loss <span class="token operator">=</span> self<span class="token punctuation">.</span>alpha <span class="token operator">*</span> student_loss <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>alpha<span class="token punctuation">)</span> <span class="token operator">*</span> distillation_loss        <span class="token keyword">return</span> <span class="token punctuation">(</span>loss<span class="token punctuation">,</span> outputs<span class="token punctuation">)</span> <span class="token keyword">if</span> return_outputs <span class="token keyword">else</span> loss<span class="token comment"># 定义训练参数，使用较小的学习率</span><span class="token comment"># 定义训练参数</span>training_args <span class="token operator">=</span> TrainingArguments<span class="token punctuation">(</span>    output_dir<span class="token operator">=</span><span class="token string">'./results'</span><span class="token punctuation">,</span>    num_train_epochs<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>    per_device_train_batch_size<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span>    per_device_eval_batch_size<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span>    logging_dir<span class="token operator">=</span><span class="token string">'./logs'</span><span class="token punctuation">,</span>    evaluation_strategy<span class="token operator">=</span><span class="token string">"epoch"</span><span class="token punctuation">,</span>    save_strategy<span class="token operator">=</span><span class="token string">"epoch"</span><span class="token punctuation">,</span>    learning_rate<span class="token operator">=</span><span class="token number">3e-5</span><span class="token punctuation">,</span>    dataloader_pin_memory<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token comment"># 初始化自定义 Trainer</span>trainer <span class="token operator">=</span> DistillationTrainer<span class="token punctuation">(</span>    teacher_model<span class="token operator">=</span>teacher_model<span class="token punctuation">,</span>    model<span class="token operator">=</span>model<span class="token punctuation">,</span>    args<span class="token operator">=</span>training_args<span class="token punctuation">,</span>    train_dataset<span class="token operator">=</span>tokenized_datasets<span class="token punctuation">[</span><span class="token string">'train'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    eval_dataset<span class="token operator">=</span>tokenized_datasets<span class="token punctuation">[</span><span class="token string">'validation'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    compute_metrics<span class="token operator">=</span>compute_metrics<span class="token punctuation">,</span>    data_collator<span class="token operator">=</span>data_collator<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token comment"># 开始训练</span>trainer<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="最后保存模型"><a href="#最后保存模型" class="headerlink" title="最后保存模型"></a>最后保存模型</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 保存模型和分词器</span>trainer<span class="token punctuation">.</span>save_model<span class="token punctuation">(</span><span class="token string">'./my_trained_model'</span><span class="token punctuation">)</span>tokenizer<span class="token punctuation">.</span>save_pretrained<span class="token punctuation">(</span><span class="token string">'./my_trained_model'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p>目前测试下来，如果整体数据集都是全新的数据，增加教师模型对于模型训练帮助不大，不如直接开始微调基座模型，因为标签和数据都是未曾见过的，教师模型无法给出建议，只会有干扰，但是这对于新数据和旧数据有一些重叠的情况会有所帮助。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h3&gt;&lt;p&gt;工作中有遇到多语言的地址、短句等数据，需要标注出其中人名、快递公司、电话等信息，现有的开源数据集中这部分数据较少，主要问题是要自己构建对应的</summary>
      
    
    
    
    <category term="技术文章" scheme="https://miaohancheng.github.io/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E7%AB%A0/"/>
    
    
    <category term="deep learning" scheme="https://miaohancheng.github.io/tags/deep-learning/"/>
    
    <category term="python" scheme="https://miaohancheng.github.io/tags/python/"/>
    
    <category term="ner" scheme="https://miaohancheng.github.io/tags/ner/"/>
    
  </entry>
  
</feed>
