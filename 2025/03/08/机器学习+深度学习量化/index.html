<!DOCTYPE html><html><head><script src="https://code.jquery.com/jquery-3.6.0.min.js"></script><meta charset="utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" name="viewport"><meta name="robots" content="index, follow"><title>机器学习+深度学习量化 - Miao Hancheng&#39;s Blog</title><meta name="description" content="背景最近在港股美股上的收益还可以，但是在择时能力上感觉靠人的判断没有特别的准确，希望通过量化的方式去帮助择时，也不希望做高频，只希望高抛低吸做t的时候可以更准确 调研一开始尝试了bigquant，发现需要开会员才能用到比较高级的因子和策略，所以找了下开源的量化回测框架和数据目前采用的是以下几个库：  talib backtrader akshare pybroker  目前做到的是用机器学习和深度"><meta property="og:type" content="article"><meta property="og:title" content="机器学习+深度学习量化"><meta property="og:url" content="https://miaohancheng.github.io/2025/03/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0+%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E9%87%8F%E5%8C%96/index.html"><meta property="og:site_name" content="Miao Hancheng&#39;s Blog"><meta property="og:description" content="背景最近在港股美股上的收益还可以，但是在择时能力上感觉靠人的判断没有特别的准确，希望通过量化的方式去帮助择时，也不希望做高频，只希望高抛低吸做t的时候可以更准确 调研一开始尝试了bigquant，发现需要开会员才能用到比较高级的因子和策略，所以找了下开源的量化回测框架和数据目前采用的是以下几个库：  talib backtrader akshare pybroker  目前做到的是用机器学习和深度"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://github.com/miaohancheng/picx-images-hosting/raw/master/pics/backtrader_plot.7axbcmuk0o.webp"><meta property="og:image" content="https://github.com/miaohancheng/picx-images-hosting/raw/master/pics/%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B.7snd18d7o4.webp"><meta property="og:image" content="https://github.com/miaohancheng/picx-images-hosting/raw/master/pics/%E6%AD%A2%E6%8D%9F.26lmndbwuu.webp"><meta property="article:published_time" content="2025-03-08T15:00:00.000Z"><meta property="article:modified_time" content="2025-03-09T13:33:00.061Z"><meta property="article:author" content="Miao Hancheng"><meta property="article:tag" content="deep learning"><meta property="article:tag" content="python"><meta property="article:tag" content="machine learning"><meta property="article:tag" content="quant trading"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://github.com/miaohancheng/picx-images-hosting/raw/master/pics/backtrader_plot.7axbcmuk0o.webp"><link rel="canonical" href="https://miaohancheng.github.io/2025/03/08/机器学习+深度学习量化/"><link rel="shortcut icon" href="/img/image.svg"><link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png"><link rel="stylesheet" href="/css/reset.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/markdown.css"><link rel="stylesheet" href="/css/fonts.css"><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Miao Hancheng's Blog" type="application/atom+xml">


<script type="application/ld+json" id="hexo-seo-schema">[
  {
    "@context": "http://schema.org",
    "@type": "WebSite",
    "url": "https://miaohancheng.github.io",
    "potentialAction": {
      "@type": "SearchAction",
      "@id": "https://developers.google.com/search/docs/advanced/structured-data/sitelinks-searchbox",
      "target": "https://www.webmanajemen.com/hexo-seo/search?q={search_term_string}",
      "query-input": "required name=search_term_string"
    }
  },
  {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "@id": "https://developers.google.com/search/docs/advanced/structured-data/breadcrumb",
    "name": "breadcrumb",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "item": "https://miaohancheng.github.io/tags/deep-learning/",
        "name": "deep learning"
      },
      {
        "@type": "ListItem",
        "position": 2,
        "item": "https://miaohancheng.github.io/tags/python/",
        "name": "python"
      },
      {
        "@type": "ListItem",
        "position": 3,
        "item": "https://miaohancheng.github.io/tags/machine-learning/",
        "name": "machine learning"
      },
      {
        "@type": "ListItem",
        "position": 4,
        "item": "https://miaohancheng.github.io/tags/quant-trading/",
        "name": "quant trading"
      },
      {
        "@type": "ListItem",
        "position": 5,
        "item": "https://miaohancheng.github.io/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E7%AB%A0/",
        "name": "技术文章"
      },
      {
        "@type": "ListItem",
        "position": 6,
        "item": "https://miaohancheng.github.io/2025/03/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0+%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E9%87%8F%E5%8C%96/",
        "name": "机器学习+深度学习量化"
      }
    ]
  },
  {
    "@context": "https://schema.org/",
    "@type": "Article",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https://miaohancheng.github.io/2025/03/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0+%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E9%87%8F%E5%8C%96/"
    },
    "headline": "机器学习+深度学习量化",
    "description": "机器学习+深度学习量化",
    "image": {
      "@type": "ImageObject",
      "url": "https://upload.wikimedia.org/wikipedia/commons/thumb/a/ac/No_image_available.svg/1200px-No_image_available.svg.png",
      "width": "250",
      "height": "250"
    },
    "author": {
      "@type": "Person",
      "name": "Miao HanCheng"
    },
    "publisher": {
      "@type": "Organization",
      "name": "Miao HanCheng",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.webmanajemen.com/2022/01/04/frp-redmi-go-tiare-fix/Bypass%20FRP%20Redmi%20Go%20Tiare%20M1903C3GG.jpg",
        "width": "125",
        "height": "125"
      }
    },
    "datePublished": "2025-03-08T15:00:00Z",
    "dateModified": "2025-03-09T13:33:00Z"
  }
]</script>

<link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml" ></head><body><div class="paper"><div class="paper-main"><div class="post-header"><a class="logo" href="/">Miao Hancheng&#39;s Blog</a><ul class="nav"><li><a href="/">Home</a></li><li><a href="/about">About</a></li><li><a href="/archives">Archives</a></li><li><a href="/tags">Tags</a></li><li><a href="/categories">Categories</a></li><li class="nav-search"><form id="search-form" onsubmit="return!1"><input type="search" id="search-input" placeholder="Search..." autocomplete="off"><div id="search-results"></div></form></li></ul></div><script src="/js/search.js"></script><div class="post-main"><div class="post-main-title">机器学习+深度学习量化</div><div class="post-meta">发布于：2025-03-08 ｜ 更新于：2025-03-09 ｜ 字数统计：2.4k 字 ｜ 浏览量：<span id="qiushaocloud_sitecounter_value_site_page_pv"></span> 次 ｜ <a href="/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E7%AB%A0/"># 技术文章</a></div><div class="post-md"><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>最近在港股美股上的收益还可以，但是在择时能力上感觉靠人的判断没有特别的准确，希望通过量化的方式去帮助择时，也不希望做高频，只希望高抛低吸做t的时候可以更准确</p><h3 id="调研"><a href="#调研" class="headerlink" title="调研"></a>调研</h3><p>一开始尝试了bigquant，发现需要开会员才能用到比较高级的因子和策略，所以找了下开源的量化回测框架和数据<br>目前采用的是以下几个库：</p><ol><li><a target="_blank" rel="nofollow noopener noreferer noreferrer external" href="https://github.com/TA-Lib/ta-lib-python:" hexo-seo="true" alt="机器学习+深度学习量化" title="机器学习+深度学习量化">talib</a></li><li><a target="_blank" rel="nofollow noopener noreferer noreferrer external" href="https://github.com/mementum/backtrader" hexo-seo="true" alt="机器学习+深度学习量化" title="机器学习+深度学习量化">backtrader</a></li><li><a target="_blank" rel="nofollow noopener noreferer noreferrer external" href="https://github.com/akfamily/akshare" hexo-seo="true" alt="机器学习+深度学习量化" title="机器学习+深度学习量化">akshare</a></li><li><a target="_blank" rel="nofollow noopener noreferer noreferrer external" href="https://github.com/edtechre/pybroker" hexo-seo="true" alt="机器学习+深度学习量化" title="机器学习+深度学习量化">pybroker</a></li></ol><p>目前做到的是用机器学习和深度学习来做未来涨跌的判定，dnn&#x2F;gnn的情况还在研究，因为构造数据集和回测框架的兼容上比机器学习难度大一些；</p><h3 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h3><p>特征粗略制作，样本就挑选了一个a股为例</p><h4 id="交易图表："><a href="#交易图表：" class="headerlink" title="交易图表："></a>交易图表：</h4><p><img src="https://github.com/miaohancheng/picx-images-hosting/raw/master/pics/backtrader_plot.7axbcmuk0o.webp" alt="汇总结论" title="汇总结论" itemprop="image"></p><h4 id="执行过程"><a href="#执行过程" class="headerlink" title="执行过程"></a>执行过程</h4><ol><li>模型训练+分步减仓<br><img src="https://github.com/miaohancheng/picx-images-hosting/raw/master/pics/%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B.7snd18d7o4.webp" alt="减仓" title="减仓" itemprop="image"></li><li>模型训练+止损<br><img src="https://github.com/miaohancheng/picx-images-hosting/raw/master/pics/%E6%AD%A2%E6%8D%9F.26lmndbwuu.webp" alt="止损" title="止损" itemprop="image"></li></ol><h4 id="数据表现："><a href="#数据表现：" class="headerlink" title="数据表现："></a>数据表现：</h4><ul><li>最终资金: 1,483,439.88 CNY （初始资金：1,000,000.00 CNY）</li><li>回测时间：2018-01-01 至 2025-03-01 的 大A</li><li>年化夏普比率: 0.51</li><li>最大回撤: 30.80% (持续 489 天)</li><li>年化收益率: 5.90%（只能跑赢通胀）</li></ul><h3 id="代码思路："><a href="#代码思路：" class="headerlink" title="代码思路："></a>代码思路：</h3><p>初始化引入：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> warnings
<span class="token keyword">import</span> logging
<span class="token keyword">import</span> akshare <span class="token keyword">as</span> ak
<span class="token keyword">import</span> backtrader <span class="token keyword">as</span> bt
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> talib <span class="token keyword">as</span> ta
<span class="token keyword">from</span> collections <span class="token keyword">import</span> Counter
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> train_test_split
<span class="token keyword">from</span> imblearn<span class="token punctuation">.</span>over_sampling <span class="token keyword">import</span> SMOTE
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword">import</span> StandardScaler
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>optim <span class="token keyword">as</span> optim


<span class="token comment"># ----------------------- 日志设置与警告屏蔽 -----------------------</span>
DEBUG <span class="token operator">=</span> <span class="token boolean">False</span>
<span class="token keyword">if</span> DEBUG<span class="token punctuation">:</span>
    logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'%(asctime)s %(levelname)s: %(message)s'</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'%(asctime)s %(levelname)s: %(message)s'</span><span class="token punctuation">)</span>

logger <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>


warnings<span class="token punctuation">.</span>filterwarnings<span class="token punctuation">(</span><span class="token string">"ignore"</span><span class="token punctuation">,</span> category<span class="token operator">=</span>UserWarning<span class="token punctuation">)</span>
warnings<span class="token punctuation">.</span>filterwarnings<span class="token punctuation">(</span><span class="token string">"ignore"</span><span class="token punctuation">,</span> category<span class="token operator">=</span>FutureWarning<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="模型构建"><a href="#模型构建" class="headerlink" title="模型构建:"></a>模型构建:</h4><ol><li><p>transfromer</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">## ----------------------- Transformer模型定义 -----------------------</span>
<span class="token keyword">class</span> <span class="token class-name">TransformerClassifier</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_dim<span class="token punctuation">,</span> nhead<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> num_encoder_layers<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> dim_feedforward<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> dropout<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>TransformerClassifier<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 如果 input_dim 不能被 nhead 整除，则增加一个线性层映射到新维度</span>
        <span class="token keyword">if</span> input_dim <span class="token operator">%</span> nhead <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
            new_input_dim <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>input_dim <span class="token operator">//</span> nhead<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> nhead
            self<span class="token punctuation">.</span>input_proj <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>input_dim<span class="token punctuation">,</span> new_input_dim<span class="token punctuation">)</span>
            d_model <span class="token operator">=</span> new_input_dim
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>input_proj <span class="token operator">=</span> <span class="token boolean">None</span>
            d_model <span class="token operator">=</span> input_dim

        encoder_layer <span class="token operator">=</span> nn<span class="token punctuation">.</span>TransformerEncoderLayer<span class="token punctuation">(</span>d_model<span class="token operator">=</span>d_model<span class="token punctuation">,</span> nhead<span class="token operator">=</span>nhead<span class="token punctuation">,</span>
                                                   dim_feedforward<span class="token operator">=</span>dim_feedforward<span class="token punctuation">,</span> dropout<span class="token operator">=</span>dropout<span class="token punctuation">,</span> batch_first<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>transformer_encoder <span class="token operator">=</span> nn<span class="token punctuation">.</span>TransformerEncoder<span class="token punctuation">(</span>encoder_layer<span class="token punctuation">,</span> num_layers<span class="token operator">=</span>num_encoder_layers<span class="token punctuation">)</span>
        <span class="token comment"># 分类层</span>
        self<span class="token punctuation">.</span>fc <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>d_model<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># x: (batch_size, seq_length, input_dim)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>input_proj <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            x <span class="token operator">=</span> self<span class="token punctuation">.</span>input_proj<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        transformer_out <span class="token operator">=</span> self<span class="token punctuation">.</span>transformer_encoder<span class="token punctuation">(</span>x<span class="token punctuation">)</span>  <span class="token comment"># (batch_size, seq_length, d_model)</span>
        pooled <span class="token operator">=</span> transformer_out<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>             <span class="token comment"># (batch_size, d_model)</span>
        output <span class="token operator">=</span> self<span class="token punctuation">.</span>fc<span class="token punctuation">(</span>pooled<span class="token punctuation">)</span>
        <span class="token keyword">return</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>output<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>Bilstm+Attention</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">
<span class="token comment"># ------------------ 定义 BiLSTM+Attention 模型 ------------------</span>
<span class="token keyword">class</span> <span class="token class-name">BiLSTMAttention</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">,</span> num_layers<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>BiLSTMAttention<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>hidden_dim <span class="token operator">=</span> hidden_dim
        self<span class="token punctuation">.</span>num_layers <span class="token operator">=</span> num_layers
        self<span class="token punctuation">.</span>lstm <span class="token operator">=</span> nn<span class="token punctuation">.</span>LSTM<span class="token punctuation">(</span>input_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">,</span> num_layers<span class="token operator">=</span>num_layers<span class="token punctuation">,</span> batch_first<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> bidirectional<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token comment"># 注意力层：将每个时刻的输出映射为一个得分</span>
        self<span class="token punctuation">.</span>attn_layer <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>hidden_dim <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>hidden_dim <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># x: (batch_size, seq_length, input_dim)</span>
        lstm_out<span class="token punctuation">,</span> _ <span class="token operator">=</span> self<span class="token punctuation">.</span>lstm<span class="token punctuation">(</span>x<span class="token punctuation">)</span>  <span class="token comment"># (batch_size, seq_length, hidden_dim*2)</span>
        attn_scores <span class="token operator">=</span> self<span class="token punctuation">.</span>attn_layer<span class="token punctuation">(</span>lstm_out<span class="token punctuation">)</span>  <span class="token comment"># (batch_size, seq_length, 1)</span>
        attn_weights <span class="token operator">=</span> torch<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>attn_scores<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># (batch_size, seq_length, 1)</span>
        context <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>attn_weights <span class="token operator">*</span> lstm_out<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># (batch_size, hidden_dim*2)</span>
        output <span class="token operator">=</span> self<span class="token punctuation">.</span>fc<span class="token punctuation">(</span>context<span class="token punctuation">)</span>  <span class="token comment"># (batch_size, 1)</span>
        output <span class="token operator">=</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>output<span class="token punctuation">)</span>
        <span class="token keyword">return</span> output<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h4 id="模型训练"><a href="#模型训练" class="headerlink" title="模型训练"></a>模型训练</h4><ol><li><p>transformer</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">
<span class="token keyword">def</span> <span class="token function">train_transformer_model</span><span class="token punctuation">(</span>X_train_seq<span class="token punctuation">,</span> y_train_seq<span class="token punctuation">,</span> X_val_seq<span class="token punctuation">,</span> y_val_seq<span class="token punctuation">,</span> input_dim<span class="token punctuation">,</span>
                            nhead<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> num_encoder_layers<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> dim_feedforward<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> dropout<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span>
                            epochs<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> patience<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    X_train_tensor <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>X_train_seq<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
    y_train_tensor <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>y_train_seq<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    X_val_tensor <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>X_val_seq<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
    y_val_tensor <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>y_val_seq<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    model <span class="token operator">=</span> TransformerClassifier<span class="token punctuation">(</span>input_dim<span class="token punctuation">,</span> nhead<span class="token punctuation">,</span> num_encoder_layers<span class="token punctuation">,</span> dim_feedforward<span class="token punctuation">,</span> dropout<span class="token punctuation">)</span>
    criterion <span class="token operator">=</span> nn<span class="token punctuation">.</span>BCELoss<span class="token punctuation">(</span><span class="token punctuation">)</span>
    optimizer <span class="token operator">=</span> optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">)</span>

    best_val_loss <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'inf'</span><span class="token punctuation">)</span>
    epochs_no_improve <span class="token operator">=</span> <span class="token number">0</span>
    best_model_state <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
        permutation <span class="token operator">=</span> torch<span class="token punctuation">.</span>randperm<span class="token punctuation">(</span>X_train_tensor<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        train_loss <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> X_train_tensor<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
            optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
            indices <span class="token operator">=</span> permutation<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i<span class="token operator">+</span>batch_size<span class="token punctuation">]</span>
            batch_x <span class="token operator">=</span> X_train_tensor<span class="token punctuation">[</span>indices<span class="token punctuation">]</span>
            batch_y <span class="token operator">=</span> y_train_tensor<span class="token punctuation">[</span>indices<span class="token punctuation">]</span>
            outputs <span class="token operator">=</span> model<span class="token punctuation">(</span>batch_x<span class="token punctuation">)</span>
            loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> batch_y<span class="token punctuation">)</span>
            loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
            optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
            train_loss <span class="token operator">+=</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> batch_x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        train_loss <span class="token operator">/=</span> X_train_tensor<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

        model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            val_outputs <span class="token operator">=</span> model<span class="token punctuation">(</span>X_val_tensor<span class="token punctuation">)</span>
            val_loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>val_outputs<span class="token punctuation">,</span> y_val_tensor<span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> val_loss <span class="token operator">&lt;</span> best_val_loss<span class="token punctuation">:</span>
            best_val_loss <span class="token operator">=</span> val_loss
            best_model_state <span class="token operator">=</span> model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span>
            epochs_no_improve <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            epochs_no_improve <span class="token operator">+=</span> <span class="token number">1</span>
            <span class="token keyword">if</span> epochs_no_improve <span class="token operator">>=</span> patience<span class="token punctuation">:</span>
                <span class="token keyword">break</span>
    <span class="token keyword">if</span> best_model_state <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>best_model_state<span class="token punctuation">)</span>
    model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        val_preds <span class="token operator">=</span> model<span class="token punctuation">(</span>X_val_tensor<span class="token punctuation">)</span>
        val_preds_binary <span class="token operator">=</span> <span class="token punctuation">(</span>val_preds <span class="token operator">>=</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        accuracy <span class="token operator">=</span> <span class="token punctuation">(</span>val_preds_binary<span class="token punctuation">.</span>eq<span class="token punctuation">(</span>y_val_tensor<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> y_val_tensor<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> model<span class="token punctuation">,</span> accuracy
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>BiLSTM+Attention</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">train_bilstm_attention_model</span><span class="token punctuation">(</span>X_train_seq<span class="token punctuation">,</span> y_train_seq<span class="token punctuation">,</span> X_val_seq<span class="token punctuation">,</span> y_val_seq<span class="token punctuation">,</span> input_dim<span class="token punctuation">,</span>
                                 hidden_dim<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> epochs<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> patience<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    X_train_tensor <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>X_train_seq<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
    y_train_tensor <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>y_train_seq<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    X_val_tensor <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>X_val_seq<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
    y_val_tensor <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>y_val_seq<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    model <span class="token operator">=</span> BiLSTMAttention<span class="token punctuation">(</span>input_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">)</span>
    criterion <span class="token operator">=</span> nn<span class="token punctuation">.</span>BCELoss<span class="token punctuation">(</span><span class="token punctuation">)</span>
    optimizer <span class="token operator">=</span> optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">)</span>

    best_val_loss <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'inf'</span><span class="token punctuation">)</span>
    epochs_no_improve <span class="token operator">=</span> <span class="token number">0</span>
    best_model_state <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
        permutation <span class="token operator">=</span> torch<span class="token punctuation">.</span>randperm<span class="token punctuation">(</span>X_train_tensor<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        train_loss <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> X_train_tensor<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
            optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
            indices <span class="token operator">=</span> permutation<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i<span class="token operator">+</span>batch_size<span class="token punctuation">]</span>
            batch_x <span class="token operator">=</span> X_train_tensor<span class="token punctuation">[</span>indices<span class="token punctuation">]</span>
            batch_y <span class="token operator">=</span> y_train_tensor<span class="token punctuation">[</span>indices<span class="token punctuation">]</span>
            outputs <span class="token operator">=</span> model<span class="token punctuation">(</span>batch_x<span class="token punctuation">)</span>
            loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> batch_y<span class="token punctuation">)</span>
            loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
            optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
            train_loss <span class="token operator">+=</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> batch_x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        train_loss <span class="token operator">/=</span> X_train_tensor<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

        model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            val_outputs <span class="token operator">=</span> model<span class="token punctuation">(</span>X_val_tensor<span class="token punctuation">)</span>
            val_loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>val_outputs<span class="token punctuation">,</span> y_val_tensor<span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> val_loss <span class="token operator">&lt;</span> best_val_loss<span class="token punctuation">:</span>
            best_val_loss <span class="token operator">=</span> val_loss
            best_model_state <span class="token operator">=</span> model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span>
            epochs_no_improve <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            epochs_no_improve <span class="token operator">+=</span> <span class="token number">1</span>
            <span class="token keyword">if</span> epochs_no_improve <span class="token operator">>=</span> patience<span class="token punctuation">:</span>
                <span class="token keyword">break</span>
    <span class="token keyword">if</span> best_model_state <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>best_model_state<span class="token punctuation">)</span>
    model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        val_preds <span class="token operator">=</span> model<span class="token punctuation">(</span>X_val_tensor<span class="token punctuation">)</span>
        val_preds_binary <span class="token operator">=</span> <span class="token punctuation">(</span>val_preds <span class="token operator">>=</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        accuracy <span class="token operator">=</span> <span class="token punctuation">(</span>val_preds_binary<span class="token punctuation">.</span>eq<span class="token punctuation">(</span>y_val_tensor<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> y_val_tensor<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> model<span class="token punctuation">,</span> accuracy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>辅助函数</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 辅助函数：构造序列数据</span>
<span class="token keyword">def</span> <span class="token function">create_sequences</span><span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">,</span> seq_length<span class="token punctuation">)</span><span class="token punctuation">:</span>
    X_seq<span class="token punctuation">,</span> y_seq <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span> <span class="token operator">-</span> seq_length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        X_seq<span class="token punctuation">.</span>append<span class="token punctuation">(</span>X<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i<span class="token operator">+</span>seq_length<span class="token punctuation">]</span><span class="token punctuation">)</span>
        y_seq<span class="token punctuation">.</span>append<span class="token punctuation">(</span>y<span class="token punctuation">[</span>i<span class="token operator">+</span>seq_length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>X_seq<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>y_seq<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h4 id="特征工程："><a href="#特征工程：" class="headerlink" title="特征工程："></a>特征工程：</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># ----------------------- 特征工程模块 -----------------------</span>
<span class="token keyword">def</span> <span class="token function">compute_features</span><span class="token punctuation">(</span>close_list<span class="token punctuation">,</span> volume_list<span class="token punctuation">,</span> prediction_window<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    构造特征数据，返回DataFrame，其中：
      - close_list: 按时间顺序排列的收盘价列表（最早在前）
      - volume_list: 成交量列表
      - prediction_window: 预测窗口（未来N日）
    """</span>
    df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'close'</span><span class="token punctuation">:</span> close_list<span class="token punctuation">,</span> <span class="token string">'volume'</span><span class="token punctuation">:</span> volume_list<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    df<span class="token punctuation">[</span><span class="token string">'high'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span>
    df<span class="token punctuation">[</span><span class="token string">'low'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span>

    <span class="token comment"># 1. 滞后收益率</span>
    <span class="token keyword">for</span> window <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        df<span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'rtn_lag_</span><span class="token interpolation"><span class="token punctuation">&#123;</span>window<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pct_change<span class="token punctuation">(</span>window<span class="token punctuation">)</span>

    <span class="token comment"># 2. 日收益率 &amp; 波动率</span>
    df<span class="token punctuation">[</span><span class="token string">'daily_return'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pct_change<span class="token punctuation">(</span><span class="token punctuation">)</span>
    df<span class="token punctuation">[</span><span class="token string">'volatility_10'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'daily_return'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span>std<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 3. 均线及差值</span>
    df<span class="token punctuation">[</span><span class="token string">'ma_20'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
    df<span class="token punctuation">[</span><span class="token string">'ma_diff'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'ma_20'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1e-8</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>

    <span class="token comment"># 4. RSI（自定义与TA版本）</span>
    delta <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>diff<span class="token punctuation">(</span><span class="token punctuation">)</span>
    gain <span class="token operator">=</span> delta<span class="token punctuation">.</span>clip<span class="token punctuation">(</span>lower<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    loss <span class="token operator">=</span> <span class="token operator">-</span>delta<span class="token punctuation">.</span>clip<span class="token punctuation">(</span>upper<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    avg_gain <span class="token operator">=</span> gain<span class="token punctuation">.</span>rolling<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
    avg_loss <span class="token operator">=</span> loss<span class="token punctuation">.</span>rolling<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
    rs <span class="token operator">=</span> avg_gain <span class="token operator">/</span> <span class="token punctuation">(</span>avg_loss <span class="token operator">+</span> <span class="token number">1e-8</span><span class="token punctuation">)</span>
    df<span class="token punctuation">[</span><span class="token string">'rsi_14_custom'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> rs<span class="token punctuation">)</span><span class="token punctuation">)</span>
    df<span class="token punctuation">[</span><span class="token string">'ta_rsi'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ta<span class="token punctuation">.</span>RSI<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> timeperiod<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span>

    <span class="token comment"># 5. MACD</span>
    df<span class="token punctuation">[</span><span class="token string">'ema_12'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ewm<span class="token punctuation">(</span>span<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">,</span> adjust<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
    df<span class="token punctuation">[</span><span class="token string">'ema_26'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ewm<span class="token punctuation">(</span>span<span class="token operator">=</span><span class="token number">26</span><span class="token punctuation">,</span> adjust<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
    df<span class="token punctuation">[</span><span class="token string">'macd_custom'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'ema_12'</span><span class="token punctuation">]</span> <span class="token operator">-</span> df<span class="token punctuation">[</span><span class="token string">'ema_26'</span><span class="token punctuation">]</span>
    df<span class="token punctuation">[</span><span class="token string">'macd_signal_custom'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'macd_custom'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ewm<span class="token punctuation">(</span>span<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">,</span> adjust<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
    df<span class="token punctuation">[</span><span class="token string">'macd_hist_custom'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'macd_custom'</span><span class="token punctuation">]</span> <span class="token operator">-</span> df<span class="token punctuation">[</span><span class="token string">'macd_signal_custom'</span><span class="token punctuation">]</span>
    df<span class="token punctuation">[</span><span class="token string">'ta_macd'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'ta_macd_signal'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'ta_macd_hist'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ta<span class="token punctuation">.</span>MACD<span class="token punctuation">(</span>
        df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> fastperiod<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">,</span> slowperiod<span class="token operator">=</span><span class="token number">26</span><span class="token punctuation">,</span> signalperiod<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">)</span>

    <span class="token comment"># 6. Bollinger Bands</span>
    df<span class="token punctuation">[</span><span class="token string">'ta_boll_upper'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'ta_boll_middle'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'ta_boll_lower'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ta<span class="token punctuation">.</span>BBANDS<span class="token punctuation">(</span>
        df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> timeperiod<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span>

    <span class="token comment"># 7. ADX</span>
    df<span class="token punctuation">[</span><span class="token string">'ta_adx'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ta<span class="token punctuation">.</span>ADX<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'high'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'low'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> timeperiod<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span>

    <span class="token comment"># 8. OBV</span>
    df<span class="token punctuation">[</span><span class="token string">'ta_obv'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ta<span class="token punctuation">.</span>OBV<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'volume'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">)</span>

    <span class="token comment"># 9. 慢速KD</span>
    slowk<span class="token punctuation">,</span> slowd <span class="token operator">=</span> ta<span class="token punctuation">.</span>STOCH<span class="token punctuation">(</span>
        df<span class="token punctuation">[</span><span class="token string">'high'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'low'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span>
        fastk_period<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">,</span> slowk_period<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> slowk_matype<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
        slowd_period<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> slowd_matype<span class="token operator">=</span><span class="token number">0</span>
    <span class="token punctuation">)</span>
    df<span class="token punctuation">[</span><span class="token string">'ta_stoch_slowk'</span><span class="token punctuation">]</span> <span class="token operator">=</span> slowk
    df<span class="token punctuation">[</span><span class="token string">'ta_stoch_slowd'</span><span class="token punctuation">]</span> <span class="token operator">=</span> slowd

    <span class="token comment"># 10. CCI</span>
    df<span class="token punctuation">[</span><span class="token string">'ta_cci'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ta<span class="token punctuation">.</span>CCI<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'high'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'low'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> timeperiod<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span>

    <span class="token comment"># 11. Momentum</span>
    df<span class="token punctuation">[</span><span class="token string">'ta_mom'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ta<span class="token punctuation">.</span>MOM<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> timeperiod<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>

    <span class="token comment"># 12. ATR</span>
    df<span class="token punctuation">[</span><span class="token string">'ta_atr'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ta<span class="token punctuation">.</span>ATR<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'high'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'low'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> timeperiod<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span>

    <span class="token comment"># 13. MFI</span>
    df<span class="token punctuation">[</span><span class="token string">'ta_mfi'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ta<span class="token punctuation">.</span>MFI<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'high'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'low'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span>
                          df<span class="token punctuation">[</span><span class="token string">'volume'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> timeperiod<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span>

    <span class="token comment"># 14. PPO</span>
    df<span class="token punctuation">[</span><span class="token string">'ta_ppo'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ta<span class="token punctuation">.</span>PPO<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> fastperiod<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">,</span> slowperiod<span class="token operator">=</span><span class="token number">26</span><span class="token punctuation">,</span> matype<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token comment"># 15. ROC</span>
    df<span class="token punctuation">[</span><span class="token string">'ta_roc'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ta<span class="token punctuation">.</span>ROC<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> timeperiod<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>

    <span class="token comment"># 16. TRIX</span>
    df<span class="token punctuation">[</span><span class="token string">'ta_trix'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ta<span class="token punctuation">.</span>TRIX<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> timeperiod<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">)</span>

    <span class="token comment"># 17. Williams %R</span>
    df<span class="token punctuation">[</span><span class="token string">'ta_willr'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ta<span class="token punctuation">.</span>WILLR<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'high'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'low'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> timeperiod<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span>

    <span class="token comment"># 18. StochRSI</span>
    df<span class="token punctuation">[</span><span class="token string">'ta_stochrsi'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ta<span class="token punctuation">.</span>STOCHRSI<span class="token punctuation">(</span>
        df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> timeperiod<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">,</span>
        fastk_period<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> fastd_period<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> fastd_matype<span class="token operator">=</span><span class="token number">0</span>
    <span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

    <span class="token comment"># 19. ULTOSC</span>
    df<span class="token punctuation">[</span><span class="token string">'ta_ultosc'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ta<span class="token punctuation">.</span>ULTOSC<span class="token punctuation">(</span>
        df<span class="token punctuation">[</span><span class="token string">'high'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'low'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span>
        timeperiod1<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span> timeperiod2<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">,</span> timeperiod3<span class="token operator">=</span><span class="token number">28</span>
    <span class="token punctuation">)</span>

    <span class="token comment"># 20. Ichimoku</span>
    <span class="token keyword">def</span> <span class="token function">compute_ichimoku</span><span class="token punctuation">(</span>high<span class="token punctuation">,</span> low<span class="token punctuation">)</span><span class="token punctuation">:</span>
        high_series <span class="token operator">=</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span>high<span class="token punctuation">)</span>
        low_series <span class="token operator">=</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span>low<span class="token punctuation">)</span>
        tenkan <span class="token operator">=</span> <span class="token punctuation">(</span>high_series<span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> low_series<span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
        kijun <span class="token operator">=</span> <span class="token punctuation">(</span>high_series<span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span><span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> low_series<span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span><span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
        senkou_span_a <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tenkan <span class="token operator">+</span> kijun<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>shift<span class="token punctuation">(</span><span class="token number">26</span><span class="token punctuation">)</span>
        senkou_span_b <span class="token operator">=</span> <span class="token punctuation">(</span>high_series<span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span><span class="token number">52</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> low_series<span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span><span class="token number">52</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
        senkou_span_b <span class="token operator">=</span> senkou_span_b<span class="token punctuation">.</span>shift<span class="token punctuation">(</span><span class="token number">26</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> tenkan<span class="token punctuation">,</span> kijun<span class="token punctuation">,</span> senkou_span_a<span class="token punctuation">,</span> senkou_span_b

    tenkan<span class="token punctuation">,</span> kijun<span class="token punctuation">,</span> senkou_a<span class="token punctuation">,</span> senkou_b <span class="token operator">=</span> compute_ichimoku<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'high'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'low'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">)</span>
    df<span class="token punctuation">[</span><span class="token string">'ichi_tenkan'</span><span class="token punctuation">]</span> <span class="token operator">=</span> tenkan
    df<span class="token punctuation">[</span><span class="token string">'ichi_kijun'</span><span class="token punctuation">]</span> <span class="token operator">=</span> kijun
    df<span class="token punctuation">[</span><span class="token string">'ichi_senkou_a'</span><span class="token punctuation">]</span> <span class="token operator">=</span> senkou_a
    df<span class="token punctuation">[</span><span class="token string">'ichi_senkou_b'</span><span class="token punctuation">]</span> <span class="token operator">=</span> senkou_b

    <span class="token comment"># 21. 未来N日累积涨跌幅（预测目标）</span>
    df<span class="token punctuation">[</span><span class="token string">'cum_return_future'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pct_change<span class="token punctuation">(</span>periods<span class="token operator">=</span>prediction_window<span class="token punctuation">)</span><span class="token punctuation">.</span>shift<span class="token punctuation">(</span><span class="token operator">-</span>prediction_window<span class="token punctuation">)</span>

    <span class="token comment"># 22. 52周range</span>
    df<span class="token punctuation">[</span><span class="token string">'52w_high'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span><span class="token number">252</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    df<span class="token punctuation">[</span><span class="token string">'52w_low'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span><span class="token number">252</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    df<span class="token punctuation">[</span><span class="token string">'range_52w'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span> <span class="token operator">-</span> df<span class="token punctuation">[</span><span class="token string">'52w_low'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'52w_high'</span><span class="token punctuation">]</span> <span class="token operator">-</span> df<span class="token punctuation">[</span><span class="token string">'52w_low'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1e-8</span><span class="token punctuation">)</span>

    <span class="token comment"># 23. PE (示例)</span>
    df<span class="token punctuation">[</span><span class="token string">'pe'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">15</span>

    <span class="token comment"># 24. 换手率</span>
    df<span class="token punctuation">[</span><span class="token string">'vol_ma_20'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'volume'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
    df<span class="token punctuation">[</span><span class="token string">'turnover'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'volume'</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'vol_ma_20'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1e-8</span><span class="token punctuation">)</span>

    <span class="token comment"># 标签：未来累计涨幅超过1%为正样本</span>
    df<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'cum_return_future'</span><span class="token punctuation">]</span> <span class="token operator">></span> <span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>

    df <span class="token operator">=</span> df<span class="token punctuation">.</span>fillna<span class="token punctuation">(</span>method<span class="token operator">=</span><span class="token string">'ffill'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fillna<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    feature_cols <span class="token operator">=</span> <span class="token punctuation">[</span>col <span class="token keyword">for</span> col <span class="token keyword">in</span> df<span class="token punctuation">.</span>columns <span class="token keyword">if</span> col <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">,</span> <span class="token string">'cum_return_future'</span><span class="token punctuation">,</span> <span class="token string">'daily_return'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    df <span class="token operator">=</span> df<span class="token punctuation">[</span>feature_cols <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">,</span> <span class="token string">'cum_return_future'</span><span class="token punctuation">,</span> <span class="token string">'daily_return'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    df <span class="token operator">=</span> df<span class="token punctuation">.</span>fillna<span class="token punctuation">(</span>method<span class="token operator">=</span><span class="token string">'ffill'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fillna<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> df<span class="token punctuation">,</span> feature_cols

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>特征上用到都是比较基础统计类的特征，时序相关的还没开，实际上如果开发时序类特征，lstm+transformer的效果会好很多</p><h4 id="主程序"><a href="#主程序" class="headerlink" title="主程序"></a>主程序</h4><p>策略上就是止盈止损+一些回撤止盈，比较简单就不写了，然后下面是代码主入口</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">
<span class="token comment"># ----------------------- 主程序 -----------------------</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    cerebro <span class="token operator">=</span> bt<span class="token punctuation">.</span>Cerebro<span class="token punctuation">(</span><span class="token punctuation">)</span>

    symbol <span class="token operator">=</span> <span class="token string">'600519'</span>
    stock_data <span class="token operator">=</span> fetch_akshare_data<span class="token punctuation">(</span>
        symbol<span class="token operator">=</span>symbol<span class="token punctuation">,</span>
        start_date<span class="token operator">=</span>pd<span class="token punctuation">.</span>to_datetime<span class="token punctuation">(</span><span class="token string">'2018-01-01'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        end_date<span class="token operator">=</span>pd<span class="token punctuation">.</span>to_datetime<span class="token punctuation">(</span><span class="token string">'2025-03-01'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"\n[数据样例]"</span><span class="token punctuation">)</span>
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span>stock_data<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\n数据时间范围: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>stock_data<span class="token punctuation">.</span>index<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string"> ~ </span><span class="token interpolation"><span class="token punctuation">&#123;</span>stock_data<span class="token punctuation">.</span>index<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    data <span class="token operator">=</span> bt<span class="token punctuation">.</span>feeds<span class="token punctuation">.</span>PandasData<span class="token punctuation">(</span>
        dataname<span class="token operator">=</span>stock_data<span class="token punctuation">,</span>
        <span class="token builtin">open</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> high<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> low<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> close<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> volume<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> openinterest<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span>
    <span class="token punctuation">)</span>
    cerebro<span class="token punctuation">.</span>adddata<span class="token punctuation">(</span>data<span class="token punctuation">)</span>

    cerebro<span class="token punctuation">.</span>addstrategy<span class="token punctuation">(</span>
        MLStrategy<span class="token punctuation">,</span>
        training_period<span class="token operator">=</span><span class="token number">504</span><span class="token punctuation">,</span>
        prediction_window<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>
        probability_threshold<span class="token operator">=</span><span class="token number">0.65</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    cerebro<span class="token punctuation">.</span>broker<span class="token punctuation">.</span>setcash<span class="token punctuation">(</span><span class="token number">1_000_000</span><span class="token punctuation">)</span>
    cerebro<span class="token punctuation">.</span>broker<span class="token punctuation">.</span>setcommission<span class="token punctuation">(</span>commission<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">)</span>

    cerebro<span class="token punctuation">.</span>addanalyzer<span class="token punctuation">(</span>bt<span class="token punctuation">.</span>analyzers<span class="token punctuation">.</span>PyFolio<span class="token punctuation">,</span> _name<span class="token operator">=</span><span class="token string">'pyfolio'</span><span class="token punctuation">)</span>
    cerebro<span class="token punctuation">.</span>addanalyzer<span class="token punctuation">(</span>bt<span class="token punctuation">.</span>analyzers<span class="token punctuation">.</span>SharpeRatio<span class="token punctuation">,</span> riskfreerate<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">,</span> annualize<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                        timeframe<span class="token operator">=</span>bt<span class="token punctuation">.</span>TimeFrame<span class="token punctuation">.</span>Days<span class="token punctuation">,</span> _name<span class="token operator">=</span><span class="token string">'sharpe'</span><span class="token punctuation">)</span>
    cerebro<span class="token punctuation">.</span>addanalyzer<span class="token punctuation">(</span>bt<span class="token punctuation">.</span>analyzers<span class="token punctuation">.</span>DrawDown<span class="token punctuation">,</span> _name<span class="token operator">=</span><span class="token string">'drawdown'</span><span class="token punctuation">)</span>
    cerebro<span class="token punctuation">.</span>addanalyzer<span class="token punctuation">(</span>bt<span class="token punctuation">.</span>analyzers<span class="token punctuation">.</span>TradeAnalyzer<span class="token punctuation">,</span> _name<span class="token operator">=</span><span class="token string">'trade_analyzer'</span><span class="token punctuation">)</span>
    cerebro<span class="token punctuation">.</span>addanalyzer<span class="token punctuation">(</span>bt<span class="token punctuation">.</span>analyzers<span class="token punctuation">.</span>TimeReturn<span class="token punctuation">,</span> timeframe<span class="token operator">=</span>bt<span class="token punctuation">.</span>TimeFrame<span class="token punctuation">.</span>Days<span class="token punctuation">,</span> _name<span class="token operator">=</span><span class="token string">'time_return'</span><span class="token punctuation">)</span>

    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"\n启动回测..."</span><span class="token punctuation">)</span>
    results <span class="token operator">=</span> cerebro<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
    strat <span class="token operator">=</span> results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

    final_value <span class="token operator">=</span> cerebro<span class="token punctuation">.</span>broker<span class="token punctuation">.</span>getvalue<span class="token punctuation">(</span><span class="token punctuation">)</span>
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\n最终资金: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>final_value<span class="token punctuation">:</span><span class="token format-spec">,.2f</span><span class="token punctuation">&#125;</span></span><span class="token string"> CNY"</span></span><span class="token punctuation">)</span>

    sharpe <span class="token operator">=</span> strat<span class="token punctuation">.</span>analyzers<span class="token punctuation">.</span>sharpe<span class="token punctuation">.</span>get_analysis<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> sharpe<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'sharperatio'</span><span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"年化夏普比率: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>sharpe<span class="token punctuation">[</span><span class="token string">'sharperatio'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"年化夏普比率: N/A"</span><span class="token punctuation">)</span>

    drawdown <span class="token operator">=</span> strat<span class="token punctuation">.</span>analyzers<span class="token punctuation">.</span>drawdown<span class="token punctuation">.</span>get_analysis<span class="token punctuation">(</span><span class="token punctuation">)</span>
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"最大回撤: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>drawdown<span class="token punctuation">[</span><span class="token string">'max'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'drawdown'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">&#125;</span></span><span class="token string">% (持续 </span><span class="token interpolation"><span class="token punctuation">&#123;</span>drawdown<span class="token punctuation">[</span><span class="token string">'max'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'len'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></span><span class="token string"> 天)"</span></span><span class="token punctuation">)</span>

    trade_analyzer <span class="token operator">=</span> strat<span class="token punctuation">.</span>analyzers<span class="token punctuation">.</span>trade_analyzer<span class="token punctuation">.</span>get_analysis<span class="token punctuation">(</span><span class="token punctuation">)</span>
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"\n交易统计: %s"</span><span class="token punctuation">,</span> trade_analyzer<span class="token punctuation">)</span>

    time_return <span class="token operator">=</span> strat<span class="token punctuation">.</span>analyzers<span class="token punctuation">.</span>time_return<span class="token punctuation">.</span>get_analysis<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>time_return<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>
        daily_returns <span class="token operator">=</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span>time_return<span class="token punctuation">)</span>
        total_ret <span class="token operator">=</span> <span class="token punctuation">(</span>daily_returns <span class="token operator">+</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>prod<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1.0</span>
        days <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>daily_returns<span class="token punctuation">)</span>
        annual_ret <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> total_ret<span class="token punctuation">)</span><span class="token operator">**</span><span class="token punctuation">(</span><span class="token number">252</span><span class="token operator">/</span>days<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token keyword">if</span> days <span class="token operator">></span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token boolean">None</span>
        <span class="token keyword">if</span> annual_ret <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"年化收益率: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>annual_ret<span class="token punctuation">:</span><span class="token format-spec">.2%</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"无法计算年化收益率"</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"time_return结果为空，无法计算年化收益率"</span><span class="token punctuation">)</span>

    figs <span class="token operator">=</span> cerebro<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>style<span class="token operator">=</span><span class="token string">'candlestick'</span><span class="token punctuation">,</span> volume<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> barup<span class="token operator">=</span><span class="token string">'red'</span><span class="token punctuation">,</span> bardown<span class="token operator">=</span><span class="token string">'green'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> figs <span class="token keyword">and</span> figs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        fig <span class="token operator">=</span> figs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        fig<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span><span class="token string">"backtrader_plot.png"</span><span class="token punctuation">)</span>
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"图形已保存为 backtrader_plot.png"</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="下一步计划"><a href="#下一步计划" class="headerlink" title="下一步计划"></a>下一步计划</h3><ol><li>构造特征要加强，要筛选出更多的因子，这次只是实验，所以因子挑选的比较简单</li><li>模型结构可以调整一下，深度和注意力可以加多</li><li>gnn再尝试一下，板块内部的股票实际上是有关联的</li></ol><p>当然这个代码非常粗糙，仅作为学习记录，如果有建议和不足请大家指正</p></div><div class="post-meta">标签： <a href="/tags/deep-learning/">/ deep learning</a> <a href="/tags/python/">/ python</a> <a href="/tags/machine-learning/">/ machine learning</a> <a href="/tags/quant-trading/">/ quant trading</a></div><script src="https://giscus.app/client.js" data-repo="miaohancheng/miaohancheng.github.io" data-repo-id="R_kgDONSmLtQ" data-category="Announcements" data-category-id="DIC_kwDONSmLtc4CkpDY" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script></div><script async src="//githubcdn.qiushaocloud.top/gh/qiushaocloud/site-counter@master/dist/qiushaocloud_site_counter.min.js"></script><div class="footer"><span>Copyright ©<script>document.write((new Date).getFullYear())</script>Miao Hancheng&#39;s Blog</span></div><link rel="stylesheet" href="/css/a11y-dark.min.css"><script src="/js/highlight.min.js"></script><script src="/js/highlightjs-line-numbers.js"></script><script>hljs.initHighlightingOnLoad(),hljs.initLineNumbersOnLoad()</script></div></div></body></html>